name: å·¥å…·åˆ—è¡¨è‡ªåŠ¨æ›´æ–°ä¸éƒ¨ç½²

on:
  push:
    branches:
      - main

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read

    steps:
    - name: æ£€å‡ºä»£ç ä»“åº“
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_TOKEN }}
        # ç¡®ä¿è·å–å®Œæ•´å†å²ï¼Œå¯¹äºåç»­çš„ Git Push æ˜¯å¿…éœ€çš„
        fetch-depth: 0 

    - name: ğŸš¨ è¯Šæ–­ï¼šæ£€æŸ¥ modules æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶æ•°é‡
      run: |
        # é€’å½’æŸ¥æ‰¾ modules/ ç›®å½•ä¸‹çš„æ‰€æœ‰ .html æ–‡ä»¶å¹¶è®¡æ•°
        FILE_COUNT=$(find modules -name "*.html" | wc -l)
        echo "ğŸš¨ è¯Šæ–­å‘ç°çš„å®é™… HTML æ–‡ä»¶æ•°é‡ï¼š$FILE_COUNT"
        if [ "$FILE_COUNT" -lt 200 ]; then
          echo "âš ï¸ è­¦å‘Šï¼šå®é™…æ–‡ä»¶æ•°é‡ ($FILE_COUNT) å°äºé¢„æœŸ (200)ã€‚è¯·æ£€æŸ¥ Git æäº¤çŠ¶æ€ã€‚"
        fi

    - name: ä¿®å¤Gitå®‰å…¨ç›®å½•æƒé™
      run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

    # å…³é”®ä¿®å¤ï¼šç¦ç”¨pipç¼“å­˜ï¼ˆå› ä¸ºæ²¡æœ‰requirements.txtï¼‰
    - name: è®¾ç½®Pythonè¿è¡Œç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: ''  # ç¦ç”¨è‡ªåŠ¨ç¼“å­˜æ£€æµ‹

    - name: å®‰è£…æ‰€éœ€ä¾èµ–
      run: |\
        python -m pip install --upgrade pip

    - name: è¿è¡Œå·¥å…·åˆ—è¡¨ç”Ÿæˆè„šæœ¬
      run: |\
        echo "æ‰§è¡Œç”Ÿæˆè„šæœ¬..."
        if [ -f "generate.py" ]; then
          python generate.py || exit 1
          echo "âœ… ç”Ÿæˆè„šæœ¬æ‰§è¡ŒæˆåŠŸ"
        else
          # æ³¨æ„ï¼šæ ¹æ®æ‚¨çš„ç»“æ„ï¼Œgenerate.pyå¯èƒ½åœ¨æ ¹ç›®å½•æˆ–scripts/ç›®å½•ä¸‹ã€‚
          # å‡è®¾å®ƒç°åœ¨ä½äºæ ¹ç›®å½•ï¼Œå¦‚æœè·¯å¾„ä¸å¯¹ï¼Œè¯·è‡ªè¡Œè°ƒæ•´
          echo "âŒ æ‰¾ä¸åˆ° generate.py æ–‡ä»¶"
          exit 1
        fi

    - name: æäº¤å¹¶æ¨é€å˜æ›´
      run: |\
        git config --global user.name "GitHub Action Bot"
        git config --global user.email "action-bot@github.com"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
        if git diff --exit-code --quiet; then
          echo "tools.json å’Œ details/ ç›®å½•æ²¡æœ‰å˜æ›´ï¼Œè·³è¿‡æäº¤ã€‚"
        else
          # æäº¤ tools.json å’Œ details æ–‡ä»¶å¤¹
          git add tools.json details
          git commit -m "chore: ğŸ¤– [CI] Auto-update tools list and detail pages"
          
          # å°è¯•æ¨é€å˜æ›´
          if ! git push; then
            echo "âŒ Gitæ¨é€å¤±è´¥ï¼Œå¯èƒ½æ˜¯æƒé™é—®é¢˜æˆ–è¿œç¨‹ä»“åº“æ²¡æœ‰å˜åŒ–"
            exit 1
          fi
          echo "âœ… å˜æ›´å·²æˆåŠŸæ¨é€åˆ°ä»“åº“"
        fi
