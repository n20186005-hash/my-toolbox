name: å·¥å…·åˆ—è¡¨è‡ªåŠ¨æ›´æ–°ä¸éƒ¨ç½²

on:
  push:
    branches:
      - main

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read

    steps:
    - name: æ£€å‡ºä»£ç ä»“åº“
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0

    - name: ä¿®å¤Gitå®‰å…¨ç›®å½•æƒé™
      run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

    # å…³é”®ä¿®å¤ï¼šç¦ç”¨pipç¼“å­˜ï¼ˆå› ä¸ºæ²¡æœ‰requirements.txtï¼‰
    - name: è®¾ç½®Pythonè¿è¡Œç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: ''  # ç¦ç”¨è‡ªåŠ¨ç¼“å­˜æ£€æµ‹

    - name: å®‰è£…æ‰€éœ€ä¾èµ–
      run: |
        python -m pip install --upgrade pip

    - name: è¿è¡Œå·¥å…·åˆ—è¡¨ç”Ÿæˆè„šæœ¬
      run: |
        echo "æ‰§è¡Œç”Ÿæˆè„šæœ¬..."
        if [ -f "scripts/generate.py" ]; then
          python scripts/generate.py || exit 1
          echo "âœ… ç”Ÿæˆè„šæœ¬æ‰§è¡ŒæˆåŠŸ"
        else
          echo "âŒ æ‰¾ä¸åˆ°scripts/generate.pyæ–‡ä»¶"
          exit 1
        fi

    - name: æäº¤å¹¶æ¨é€å˜æ›´
      run: |
        git config --global user.name "GitHub Action Bot"
        git config --global user.email "action-bot@github.com"
        
        git fetch origin main
        git reset --hard origin/main
        
        git add tools.json details/ || echo "âš ï¸ ç›®æ ‡æ–‡ä»¶ä¸å­˜åœ¨"
        
        if git diff --quiet && git diff --staged --quiet; then
          echo "âœ… æ— å˜æ›´ï¼Œæ— éœ€æäº¤"
        else
          git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°å·¥å…·åˆ—è¡¨"
          git push origin main
          echo "ğŸ“¤ æ¨é€æˆåŠŸ"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
