name: å·¥å…·åˆ—è¡¨è‡ªåŠ¨æ›´æ–°ä¸éƒ¨ç½²

# è§¦å‘æ¡ä»¶ï¼šæ¨é€ä»£ç åˆ° main åˆ†æ”¯æ—¶æ‰§è¡Œ
on:
  push:
    branches:
      - main

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    # å¿…è¦çš„æƒé™è®¾ç½®ï¼Œç¡®ä¿èƒ½æ¨é€ä»£ç 
    permissions:
      contents: write
      pull-requests: read

    steps:
    # 1. æ‹‰å–ä»“åº“ä»£ç 
    - name: æ£€å‡ºä»£ç ä»“åº“
     - uses: actions/checkout@v4  # ç¡®ä¿æ˜¯æœ€æ–°ç‰ˆæœ¬
  with:
    token: ${{ secrets.GITHUB_TOKEN }}  # æˆ–è‡ªå®šä¹‰çš„ACCESS_TOKEN

    # 2. é…ç½®Pythonç¯å¢ƒ
    - name: è®¾ç½®Pythonè¿è¡Œç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'  # æŒ‡å®šå…·ä½“ç‰ˆæœ¬ï¼Œæé«˜ç¨³å®šæ€§
        cache: ''  # ç¦ç”¨è‡ªåŠ¨ä¾èµ–æ£€æµ‹ï¼Œè§£å†³æ— requirements.txtæ—¶çš„æŠ¥é”™

    # 3. å®‰è£…ä¾èµ–åŒ…
    - name: å®‰è£…æ‰€éœ€ä¾èµ–
      run: |
        echo "æ›´æ–°pipå·¥å…·..."
        python -m pip install --upgrade pip
        # å¦‚æœ‰ä¾èµ–éœ€æ±‚ï¼Œå–æ¶ˆä¸‹é¢æ³¨é‡Šå¹¶åˆ›å»ºrequirements.txt
        # echo "å®‰è£…é¡¹ç›®ä¾èµ–..."
        # pip install -r requirements.txt

    # 4. æ‰§è¡Œç”Ÿæˆè„šæœ¬
    - name: è¿è¡Œå·¥å…·åˆ—è¡¨ç”Ÿæˆè„šæœ¬
      run: |
        echo "å¼€å§‹æ‰§è¡Œç”Ÿæˆè„šæœ¬ scripts/generate.py..."
        if python scripts/generate.py; then
          echo "âœ… ç”Ÿæˆè„šæœ¬æ‰§è¡ŒæˆåŠŸ"
        else
          echo "âŒ ç”Ÿæˆè„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥scripts/generate.py"
          exit 1
        fi

    # 5. æäº¤å¹¶æ¨é€å˜æ›´
    - name: æäº¤å¹¶æ¨é€ç”Ÿæˆçš„æ–‡ä»¶
      run: |
        # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
        git config --global user.name "GitHub Action Bot"
        git config --global user.email "action-bot@github.com"
        
        # æ‹‰å–æœ€æ–°ä»£ç ï¼Œå¤„ç†å¯èƒ½çš„å†²çª
        echo "æ‹‰å–æœ€æ–°ä»£ç ä»¥é¿å…å†²çª..."
        git pull origin main --rebase
        
        # æ·»åŠ éœ€è¦è·Ÿè¸ªçš„æ–‡ä»¶
        echo "æ·»åŠ ç”Ÿæˆçš„æ–‡ä»¶..."
        git add tools.json details/
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff --quiet && git diff --staged --quiet; then
          echo "âœ… æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œæ— éœ€æäº¤"
        else
          echo "æäº¤å˜æ›´..."
          git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°å·¥å…·åˆ—è¡¨ [GitHub Action]"
          echo "æ¨é€å˜æ›´åˆ°ä»“åº“..."
          git push https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }}.git main
          echo "ğŸ“¤ å˜æ›´æ¨é€æˆåŠŸ"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: false

