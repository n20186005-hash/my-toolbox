<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Category Meta Tag -->
    <meta name="category" content="fun">
    <meta name="icon" content="ğŸ®">
    <meta name="description" content="Online Binary Logarithm (Log2) Calculator - Calculate base-2 logarithms instantly for computer science and math. Includes powers of 2 chart and formulas.">
    <title>å››å¹´çº§ä¸‹å†Œç§‘å­¦å¤§é—¯å…³</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a' }
                    },
                    animation: {
                        'bounce-slight': 'bounce-slight 2s infinite',
                        'fade-in': 'fadeIn 0.5s ease-out',
                    },
                    keyframes: {
                        'bounce-slight': {
                            '0%, 100%': { transform: 'translateY(-5%)' },
                            '50%': { transform: 'translateY(0)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
            touch-action: manipulation;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            height: 100vh;
            height: 100dvh; 
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .game-card {
            border-radius: 1.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn {
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        .btn:active { transform: scale(0.96); }
        
        /* é€‰ä¸­æ€ç‰¹æ•ˆ */
        .option-btn { border-width: 2px; transition: all 0.2s; }
        .option-btn:active { transform: translateY(0); }

        /* Matching Game Styles */
        .match-card {
            transition: all 0.3s;
            backface-visibility: hidden;
        }
        .match-selected {
            background-color: #3b82f6;
            color: white;
            transform: scale(1.05);
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        .match-correct {
            animation: pop-out 0.5s forwards;
        }
        @keyframes pop-out {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0); opacity: 0; }
        }

        /* Animations */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-8px) rotate(-5deg); }
            40% { transform: translateX(8px) rotate(5deg); }
            60% { transform: translateX(-4px); }
            80% { transform: translateX(4px); }
        }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }

        @keyframes pop {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-in { animation: pop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }

        .theme-transition {
            transition: background-color 0.3s, color 0.3s, border-color 0.3s, box-shadow 0.3s;
        }
    </style>
</head>
<body class="bg-blue-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 flex flex-col items-center justify-center overflow-hidden relative selection:bg-blue-200 theme-transition">

    <!-- Top Controls -->
    <div class="absolute top-4 right-4 z-50 flex gap-2">
        <button onclick="toggleMute()" class="p-2 rounded-full bg-white/80 dark:bg-slate-800/80 backdrop-blur shadow-md text-xl btn border border-slate-200 dark:border-slate-700" title="é™éŸ³å¼€å…³">
            <span id="mute-icon">ğŸ”Š</span>
        </button>
        <button onclick="toggleTheme()" class="p-2 rounded-full bg-white/80 dark:bg-slate-800/80 backdrop-blur shadow-md text-xl btn border border-slate-200 dark:border-slate-700" title="åˆ‡æ¢æ¨¡å¼">
            <span id="theme-icon">â˜€ï¸</span>
        </button>
        <button onclick="resetGame()" class="p-2 rounded-full bg-red-100 dark:bg-red-900/50 backdrop-blur shadow-md text-xl btn border border-red-200 dark:border-red-800 text-red-600" title="é‡ç½®æ¸¸æˆ">
            <span>ğŸ”„</span>
        </button>
    </div>

    <!-- Background Decoration -->
    <div class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
        <div class="absolute top-10 left-10 text-6xl opacity-20 dark:opacity-10 animate-bounce-slight" style="animation-delay: 0s">ğŸŒ¡ï¸</div>
        <div class="absolute bottom-20 right-10 text-6xl opacity-20 dark:opacity-10 animate-bounce-slight" style="animation-delay: 1s">ğŸŒ</div>
        <div class="absolute top-1/2 left-1/4 text-4xl opacity-20 dark:opacity-10 animate-bounce-slight" style="animation-delay: 2s">ğŸ›</div>
        <div class="absolute top-20 right-20 text-5xl opacity-20 dark:opacity-10 animate-bounce-slight" style="animation-delay: 1.5s">ğŸŒ±</div>
    </div>

    <!-- START SCREEN -->
    <div id="start-screen" class="text-center max-w-md w-full p-6 flex flex-col items-center z-10 overflow-y-auto max-h-screen no-scrollbar">
        <div class="mb-6 relative py-4">
            <h1 class="text-5xl font-black text-blue-600 dark:text-blue-400 mb-2 tracking-tight drop-shadow-sm">ç§‘å­¦å¤§é—¯å…³</h1>
            <span class="bg-yellow-400 text-yellow-900 text-xs font-bold px-2 py-1 rounded absolute -right-4 top-2 transform rotate-12 shadow-sm">å¨åŠ›åŠ å¼ºç‰ˆ</span>
        </div>
        
        <div class="bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl mb-6 w-full border border-blue-100 dark:border-slate-700">
            <h3 class="text-slate-500 dark:text-slate-400 font-bold mb-4 text-sm uppercase tracking-wider">é€‰æ‹©æ¸¸æˆæ¨¡å¼</h3>
            
            <!-- æŒ‘æˆ˜æ¨¡å¼ -->
            <button onclick="showDifficultySelect('normal')" class="btn w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white text-lg font-bold py-4 px-6 rounded-2xl shadow-lg mb-3 flex items-center justify-between group">
                <span class="flex items-center gap-3">
                    <span class="bg-white/20 p-2 rounded-lg">â¤ï¸</span>
                    <span class="text-left">
                        <div class="leading-none">æŒ‘æˆ˜æ¨¡å¼</div>
                        <div class="text-xs font-normal opacity-80 mt-1">æœ‰é™ç”Ÿå‘½ Â· ç§¯åˆ†é—¯å…³</div>
                    </span>
                </span>
                <span class="text-2xl">â†’</span>
            </button>

            <!-- ç»ƒä¹ æ¨¡å¼ -->
            <button onclick="startGame('infinite', 'scholar')" class="btn w-full bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-200 text-lg font-bold py-4 px-6 rounded-2xl shadow-lg border-2 border-slate-100 dark:border-slate-600 mb-3 flex items-center justify-between group">
                <span class="flex items-center gap-3">
                    <span class="bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 p-2 rounded-lg">â™¾ï¸</span>
                    <span class="text-left">
                        <div class="leading-none">ç»ƒä¹ æ¨¡å¼</div>
                        <div class="text-xs font-normal opacity-60 dark:opacity-50 mt-1">æ— é™å¤æ´» Â· åˆ·å®Œä¸ºæ­¢</div>
                    </span>
                </span>
                <span class="text-2xl">â†’</span>
            </button>

            <!-- é…å¯¹æŒ‘æˆ˜ -->
            <button onclick="startMatchingGame()" class="btn w-full bg-purple-50 dark:bg-purple-900/20 text-purple-700 dark:text-purple-300 text-lg font-bold py-4 px-6 rounded-2xl shadow-lg border-2 border-purple-100 dark:border-purple-800 flex items-center justify-between group">
                <span class="flex items-center gap-3">
                    <span class="bg-purple-200 dark:bg-purple-800 text-purple-600 dark:text-purple-200 p-2 rounded-lg">ğŸ§©</span>
                    <span class="text-left">
                        <div class="leading-none">é…å¯¹æŒ‘æˆ˜</div>
                        <div class="text-xs font-normal opacity-60 dark:opacity-50 mt-1">è¿çº¿æ¶ˆé™¤ Â· æ¦‚å¿µå¼ºåŒ–</div>
                    </span>
                </span>
                <span class="text-2xl">â†’</span>
            </button>
        </div>
    </div>

    <!-- DIFFICULTY SELECT MODAL -->
    <div id="difficulty-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-2xl w-full max-w-sm border border-slate-100 dark:border-slate-700 pop-in">
            <h3 class="text-xl font-bold text-center mb-6 dark:text-white">é€‰æ‹©æŒ‘æˆ˜éš¾åº¦</h3>
            
            <button onclick="startGame('normal', 'newbie')" class="btn w-full mb-3 bg-green-100 text-green-700 p-4 rounded-xl font-bold border border-green-200 flex justify-between items-center">
                <span>ğŸ£ æ–°æ‰‹å…¥é—¨</span>
                <span class="text-xs bg-white/50 px-2 py-1 rounded">10é¢˜</span>
            </button>
            <button onclick="startGame('normal', 'master')" class="btn w-full mb-3 bg-blue-100 text-blue-700 p-4 rounded-xl font-bold border border-blue-200 flex justify-between items-center">
                <span>ğŸ¯ é«˜æ‰‹è¿›é˜¶</span>
                <span class="text-xs bg-white/50 px-2 py-1 rounded">20é¢˜</span>
            </button>
            <button onclick="startGame('normal', 'scholar')" class="btn w-full mb-4 bg-orange-100 text-orange-700 p-4 rounded-xl font-bold border border-orange-200 flex justify-between items-center">
                <span>ğŸ“ é¡¶çº§å­¦éœ¸</span>
                <span class="text-xs bg-white/50 px-2 py-1 rounded">å…¨éƒ¨é¢˜ç›®</span>
            </button>

            <button onclick="hideDifficultySelect()" class="w-full py-2 text-slate-400 text-sm font-bold">è¿”å›</button>
        </div>
    </div>

    <!-- QUIZ SCREEN -->
    <div id="game-screen" class="hidden w-full max-w-lg flex flex-col h-full justify-between relative">
        <!-- Header -->
        <div class="relative z-20 px-4 pt-4 pb-2 bg-blue-50/95 dark:bg-slate-900/95 backdrop-blur-sm flex-shrink-0">
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-2">
                    <span id="lives-display" class="flex items-center gap-1 text-red-500 text-xl"></span>
                    <div id="skip-btn-container" class="ml-2">
                        <button onclick="skipQuestion()" class="text-xs bg-slate-200 dark:bg-slate-700 px-2 py-1 rounded-lg text-slate-600 dark:text-slate-300 font-bold hover:bg-slate-300">
                            â© è·³è¿‡ (<span id="skips-left">3</span>)
                        </button>
                    </div>
                </div>
                <div class="font-mono text-blue-600 dark:text-blue-400 font-black text-2xl">
                    <span id="score-display">0</span>
                </div>
            </div>
            <div class="w-full bg-white dark:bg-slate-700 rounded-full h-2 overflow-hidden">
                <div id="progress-bar" class="bg-blue-500 h-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>

        <!-- Question Area -->
        <div class="flex-grow overflow-y-auto px-4 py-4 no-scrollbar z-10 w-full max-w-lg mx-auto flex flex-col">
            <div id="question-card" class="game-card bg-white dark:bg-slate-800 p-6 shadow-xl border border-slate-100 dark:border-slate-700 relative mt-4">
                <span id="unit-tag" class="absolute -top-3 left-4 text-xs font-black px-3 py-1 rounded-full uppercase tracking-wide shadow-sm">
                    UNIT
                </span>
                
                <h2 id="question-text" class="text-lg md:text-xl font-bold text-slate-800 dark:text-slate-100 mb-6 mt-2 leading-relaxed">
                    Loading...
                </h2>

                <div id="options-container" class="space-y-3"></div>
                
                <!-- Feedback Area -->
                <div id="feedback-area" class="hidden mt-6 p-4 bg-amber-50 dark:bg-amber-900/30 rounded-xl border-l-4 border-amber-400 dark:border-amber-600 animate-fade-in">
                    <div class="flex items-start gap-3">
                        <span class="text-xl">ğŸ’¡</span>
                        <div>
                            <p class="font-bold text-xs text-amber-600 dark:text-amber-400 mb-1">è§£æ</p>
                            <p id="explanation-text" class="text-sm dark:text-slate-200 font-medium leading-relaxed"></p>
                        </div>
                    </div>
                    <button onclick="nextQuestion()" class="mt-3 w-full bg-amber-500 text-white py-2 rounded-lg font-bold shadow-md">ä¸‹ä¸€é¢˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MATCHING GAME SCREEN -->
    <div id="matching-screen" class="hidden w-full max-w-2xl h-full flex flex-col p-4 relative">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-black text-purple-600 dark:text-purple-400">é…å¯¹æŒ‘æˆ˜</h2>
            <div class="text-sm font-bold text-slate-500 dark:text-slate-400">å‰©ä½™: <span id="match-pairs-left">0</span> ç»„</div>
        </div>
        
        <div id="matching-grid" class="grid grid-cols-2 gap-4 flex-grow content-start overflow-y-auto no-scrollbar pb-8">
            <!-- Items injected here -->
        </div>

        <!-- Matching Feedback Overlay -->
        <div id="match-feedback" class="hidden absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white dark:bg-slate-800 px-6 py-4 rounded-2xl shadow-2xl z-50 text-center border-2 border-green-500 pop-in">
            <div class="text-4xl mb-2">âœ¨</div>
            <div class="font-bold text-green-600">é…å¯¹æˆåŠŸ!</div>
        </div>
    </div>

    <!-- END SCREEN & WRONG ANSWERS -->
    <div id="end-screen" class="hidden text-center max-w-md w-full p-6 z-20 overflow-y-auto max-h-screen no-scrollbar">
        <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl p-8 border border-slate-100 dark:border-slate-700">
            <div class="text-7xl mb-4 animate-bounce" id="end-emoji">ğŸ†</div>
            <h2 class="text-3xl font-black text-slate-800 dark:text-white mb-2">æŒ‘æˆ˜ç»“æŸ</h2>
            <p class="text-slate-500 dark:text-slate-400 mb-6 text-sm">æœ¬æ¬¡æŒ‘æˆ˜ç»¼åˆè¯„åˆ†</p>
            
            <div class="flex justify-center items-center mb-8 relative">
                <div class="relative z-10">
                    <span class="text-7xl font-black bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600 dark:from-blue-400 dark:to-purple-400" id="final-score">0</span>
                    <span class="text-2xl font-bold text-slate-400 ml-1">åˆ†</span>
                </div>
                <!-- Background decoration for score -->
                <div class="absolute w-24 h-24 bg-blue-100 dark:bg-blue-900/30 rounded-full blur-xl -z-10"></div>
            </div>

            <div class="flex gap-3 mb-6">
                <button onclick="showWrongAnswers()" id="review-btn" class="flex-1 btn bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-300 py-4 rounded-xl font-bold border border-red-100 dark:border-red-800 hidden flex items-center justify-center gap-2 group">
                    <span>ğŸ“</span> æŸ¥çœ‹é”™é¢˜æœ¬
                    <span class="bg-red-200 dark:bg-red-800 text-xs px-2 py-0.5 rounded-full" id="wrong-count-badge">0</span>
                </button>
            </div>
            
            <button onclick="showStartScreen()" class="w-full btn bg-slate-800 dark:bg-slate-600 text-white py-4 rounded-xl font-bold shadow-lg">
                ğŸ  è¿”å›ä¸»é¡µ
            </button>
        </div>
    </div>

    <!-- WRONG ANSWERS MODAL (Optimized UI) -->
    <div id="wrong-answers-modal" class="hidden fixed inset-0 z-50 flex flex-col bg-white dark:bg-slate-900">
        <div class="p-4 border-b dark:border-slate-700 flex justify-between items-center bg-white dark:bg-slate-900 shadow-sm z-10">
            <div class="flex items-center gap-2">
                <h3 class="text-lg font-black text-slate-800 dark:text-white">é”™é¢˜å›é¡¾</h3>
                <span class="bg-red-100 text-red-600 text-xs font-bold px-2 py-1 rounded-full">å¼ºåŒ–å¤ä¹ </span>
            </div>
            <button onclick="closeWrongAnswers()" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 flex items-center justify-center font-bold">Ã—</button>
        </div>
        <div id="wrong-list" class="flex-grow overflow-y-auto p-4 space-y-4 bg-slate-50 dark:bg-slate-950 pb-20">
            <!-- Wrong items injected -->
        </div>
        <div class="p-4 bg-white dark:bg-slate-900 border-t dark:border-slate-700">
             <button onclick="closeWrongAnswers()" class="w-full btn bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg">
                æˆ‘è®°ä½äº†
            </button>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒé¢˜åº“ (åŸºäºPDFæ·±åº¦æ‰©å±•) ---
        const fullQuestionBank = [
            // ç¬¬ä¸€å•å…ƒï¼šå†·å’Œçƒ­
            { unit: "å†·å’Œçƒ­", unitId: 1, q: "æ¸©åº¦è®¡è¯»æ•°æ—¶ï¼Œè§†çº¿åº”ï¼Ÿ", options: ["ä¿¯è§†", "å¹³è§†æ¶²é¢", "ä»°è§†", "éšæ„"], a: 1, info: "è¯»æ•°æ—¶è§†çº¿ä¸æ¶²æŸ±ä¸Šè¡¨é¢ä¿æŒæ°´å¹³ã€‚" },
            { unit: "å†·å’Œçƒ­", unitId: 1, q: "ç‰©ä½“å—çƒ­ä½“ç§¯å¢å¤§ï¼Œé‡å†·ç¼©å°ï¼Œå«ï¼Ÿ", options: ["çƒ­èƒ€å†·ç¼©", "åŒ–å­¦ååº”", "è’¸å‘", "å‡ç»“"], a: 0, info: "è¿™æ˜¯çƒ­èƒ€å†·ç¼©ç°è±¡ã€‚" },
            { unit: "å†·å’Œçƒ­", unitId: 1, q: "æ°´æ²¸è…¾æ—¶çš„æ¸©åº¦é€šå¸¸æ˜¯ï¼Ÿ", options: ["0â„ƒ", "50â„ƒ", "100â„ƒ", "37â„ƒ"], a: 2, info: "æ ‡å‡†å¤§æ°”å‹ä¸‹ï¼Œæ°´çš„æ²¸ç‚¹æ˜¯100â„ƒã€‚" },
            { unit: "å†·å’Œçƒ­", unitId: 1, q: "æ°´ç»“å†°åä½“ç§¯ä¼šï¼Ÿ", options: ["å˜å¤§", "å˜å°", "ä¸å˜", "æ¶ˆå¤±"], a: 0, info: "æ°´æ˜¯ç‰¹ä¾‹ï¼Œç»“å†°æ—¶ä½“ç§¯ä¼šå¢å¤§ã€‚" },
            { unit: "å†·å’Œçƒ­", unitId: 1, q: "é…’ç²¾ç¯åŠ çƒ­ç‰©ä½“åº”è¯¥ç”¨ç«ç„°çš„å“ªéƒ¨åˆ†ï¼Ÿ", options: ["ç„°å¿ƒ", "å†…ç„°", "å¤–ç„°", "ç¯èŠ¯"], a: 2, info: "å¤–ç„°æ¸©åº¦æœ€é«˜ï¼Œåº”ä½¿ç”¨å¤–ç„°åŠ çƒ­ã€‚" },
            { unit: "å†·å’Œçƒ­", unitId: 1, q: "å†°èåŒ–æˆæ°´æ—¶ï¼Œæ¸©åº¦ä¼šï¼Ÿ", options: ["ä¸€ç›´ä¸Šå‡", "ä¿æŒ0â„ƒç›´åˆ°èåŒ–å®Œæˆ", "è¿…é€Ÿä¸‹é™", "å¿½é«˜å¿½ä½"], a: 1, info: "å†°èåŒ–è¿‡ç¨‹ä¸­ï¼Œæ¸©åº¦ä¿æŒåœ¨0â„ƒä¸å˜ï¼Œç›´åˆ°å…¨éƒ¨å˜æˆæ°´ã€‚" },
            { unit: "å†·å’Œçƒ­", unitId: 1, q: "æ°´è’¸æ°”é‡å†·å˜æˆæ¶²æ€æ°´ï¼Œå«ï¼Ÿ", options: ["å‡ç»“", "è’¸å‘", "å‡å", "æ²¸è…¾"], a: 0, info: "æ°”æ€å˜æ¶²æ€å«å‡ç»“ï¼Œå¦‚ç™½æ°”ã€éœ²æ°´ã€‚" },
            { unit: "å†·å’Œçƒ­", unitId: 1, q: "ç†„ç­é…’ç²¾ç¯çš„æ­£ç¡®æ–¹æ³•æ˜¯ï¼Ÿ", options: ["ç”¨å˜´å¹", "ç”¨ä¹¦æ‰‡", "ç”¨ç¯å¸½ç›–ç­", "ç”¨æ°´æµ‡"], a: 2, info: "å¿…é¡»ç”¨ç¯å¸½ç›–ç­ï¼Œä¸”è¦ç›–ä¸¤æ¬¡ï¼ˆé˜²å‹å¼ºå·®ï¼‰ã€‚" },
            
            // ç¬¬äºŒå•å…ƒï¼šåœ°çƒæœˆçƒå¤ªé˜³
            { unit: "åœ°çƒå®‡å®™", unitId: 2, q: "é¦–ä½å®Œæˆç¯çƒèˆªè¡Œè¯æ˜åœ°çƒæ˜¯çƒä½“çš„æ˜¯ï¼Ÿ", options: ["å“¥ä¼¦å¸ƒ", "éº¦å“²ä¼¦", "éƒ‘å’Œ", "åŠ åŠ æ—"], a: 1, info: "1519å¹´éº¦å“²ä¼¦èˆ¹é˜Ÿå®Œæˆäº†ç¬¬ä¸€æ¬¡ç¯çƒèˆªè¡Œã€‚" },
            { unit: "åœ°çƒå®‡å®™", unitId: 2, q: "æœˆçƒæ˜¯åœ°çƒçš„ï¼Ÿ", options: ["æ’æ˜Ÿ", "è¡Œæ˜Ÿ", "å«æ˜Ÿ", "å½—æ˜Ÿ"], a: 2, info: "æœˆçƒå›´ç»•åœ°çƒè¿è¡Œï¼Œæ˜¯åœ°çƒçš„å¤©ç„¶å«æ˜Ÿã€‚" },
            { unit: "åœ°çƒå®‡å®™", unitId: 2, q: "é˜³å…‰ä¸‹å½±å­æ–¹å‘ä¸å¤ªé˜³æ–¹å‘ï¼Ÿ", options: ["ç›¸åŒ", "ç›¸å", "å‚ç›´", "æ— å…³"], a: 1, info: "å…‰æ²¿ç›´çº¿ä¼ æ’­ï¼Œå½±å­æ€»åœ¨èƒŒå…‰ä¸€ä¾§ã€‚" },
            { unit: "åœ°çƒå®‡å®™", unitId: 2, q: "ä¸€å¤©ä¸­å½±å­æœ€çŸ­çš„æ—¶å€™æ˜¯ï¼Ÿ", options: ["æ—©æ™¨", "æ­£åˆ", "å‚æ™š", "æ·±å¤œ"], a: 1, info: "æ­£åˆå¤ªé˜³é«˜åº¦è§’æœ€å¤§ï¼Œå½±å­æœ€çŸ­ã€‚" },
            { unit: "åœ°çƒå®‡å®™", unitId: 2, q: "å¤ªé˜³æ˜¯ä¸€é¢—ï¼Ÿ", options: ["è¡Œæ˜Ÿ", "å«æ˜Ÿ", "æ’æ˜Ÿ", "æµæ˜Ÿ"], a: 2, info: "å¤ªé˜³è‡ªèº«å‘å…‰å‘çƒ­ï¼Œæ˜¯æ’æ˜Ÿã€‚" },
            { unit: "åœ°çƒå®‡å®™", unitId: 2, q: "æœˆç›¸å˜åŒ–çš„å‘¨æœŸå¤§çº¦æ˜¯ï¼Ÿ", options: ["ä¸€å¤©", "ä¸€å¹´", "å†œå†ä¸€ä¸ªæœˆ", "ä¸€å‘¨"], a: 2, info: "ä¸¤æ¬¡æ»¡æœˆé—´éš”çº¦30å¤©ï¼Œå³å†œå†çš„ä¸€ä¸ªæœˆã€‚" },
            { unit: "åœ°çƒå®‡å®™", unitId: 2, q: "åœ°çƒä¸Šçœ‹æœˆçƒè¡¨é¢è“è‰²çš„éƒ¨åˆ†æ˜¯ï¼Ÿ", options: ["æµ·æ´‹", "æ£®æ—", "å†°å·", "å…¶å®æœˆçƒæ²¡æœ‰è“è‰²"], a: 3, info: "é¢˜ç›®é™·é˜±ï¼šä»å¤ªç©ºçœ‹åœ°çƒè“è‰²æ˜¯æµ·æ´‹ã€‚æœˆçƒæ²¡æœ‰æ¶²æ€æ°´ï¼Œåªæœ‰é˜´æš—çš„æœˆæµ·ï¼ˆå¹³åŸï¼‰ã€‚" },
            { unit: "åœ°çƒå®‡å®™", unitId: 2, q: "å¤ä»£åˆ©ç”¨å¤ªé˜³æŠ•å½±è®¡æ—¶çš„å·¥å…·å«ï¼Ÿ", options: ["æŒ‡å—é’ˆ", "æ—¥æ™·", "æ°´é’Ÿ", "æ²™æ¼"], a: 1, info: "æ—¥æ™·æ˜¯åˆ©ç”¨æ—¥å½±æµ‹å¾—æ—¶åˆ»çš„è®¡æ—¶ä»ªå™¨ã€‚" },
            { unit: "åœ°çƒå®‡å®™", unitId: 2, q: "å†œå†ä¸‹åŠæœˆçš„æœˆç›¸äº®é¢åœ¨ï¼Ÿ", options: ["å·¦è¾¹", "å³è¾¹", "ä¸Šé¢", "ä¸‹é¢"], a: 0, info: "ä¸ŠåŠæœˆäº®é¢åœ¨å³ï¼ˆç”±ç¼ºå˜åœ†ï¼‰ï¼Œä¸‹åŠæœˆäº®é¢åœ¨å·¦ï¼ˆç”±åœ†å˜ç¼ºï¼‰ã€‚" },

            // ç¬¬ä¸‰å•å…ƒï¼šæ˜†è™«
            { unit: "æ˜†è™«", unitId: 3, q: "æ˜†è™«èº«ä½“åˆ†ä¸ºå“ªä¸‰éƒ¨åˆ†ï¼Ÿ", options: ["å¤´ã€é¢ˆã€èº«", "å¤´ã€èƒ¸ã€è…¹", "å¤´ã€èº¯å¹²ã€å°¾", "å¤´ã€æ‰‹ã€è„š"], a: 1, info: "æ˜†è™«ç‰¹å¾ï¼šå¤´èƒ¸è…¹ï¼Œä¸€å¯¹è§¦è§’ä¸‰å¯¹è¶³ã€‚" },
            { unit: "æ˜†è™«", unitId: 3, q: "æ˜†è™«æœ‰å‡ æ¡è…¿ï¼Ÿ", options: ["4æ¡", "6æ¡", "8æ¡", "10æ¡"], a: 1, info: "èƒ¸éƒ¨æœ‰3å¯¹è¶³ï¼Œå…±6æ¡è…¿ã€‚" },
            { unit: "æ˜†è™«", unitId: 3, q: "èš•çš„ä¸€ç”Ÿç»å†ï¼Ÿ", options: ["åµ-å¹¼è™«-æˆè™«", "åµ-å¹¼è™«-è›¹-æˆè™«", "å¹¼è™«-è›¹-æˆè™«", "åµ-è›¹-æˆè™«"], a: 1, info: "èš•æ˜¯å®Œå…¨å˜æ€å‘è‚²ï¼šåµã€å¹¼è™«ã€è›¹ã€æˆè™«ã€‚" },
            { unit: "æ˜†è™«", unitId: 3, q: "èš•å®å®â€œçœ â€æ˜¯æŒ‡ï¼Ÿ", options: ["ç¡è§‰", "æ­»äº¡", "èœ•çš®å‰çš„é™æ­¢", "ç”Ÿç—…"], a: 2, info: "ä¸åƒä¸åŠ¨ï¼Œå‡†å¤‡èœ•çš®ï¼Œç§°ä¸ºâ€œçœ â€ã€‚" },
            { unit: "æ˜†è™«", unitId: 3, q: "ç§ç±»æœ€å¤šçš„æ˜†è™«ç±»ç¾¤æ˜¯ï¼Ÿ", options: ["ç”²è™«", "è´è¶", "èœ‚ç±»", "è‡ç±»"], a: 0, info: "ç”²è™«å æ˜†è™«æ€»æ•°çš„40%å·¦å³ã€‚" },
            { unit: "æ˜†è™«", unitId: 3, q: "ä¸‹åˆ—å“ªä¸ªæ˜¯æ˜†è™«ï¼Ÿ", options: ["èœ˜è››", "èœˆèš£", "èš‚èš", "èœ—ç‰›"], a: 2, info: "èš‚èšæœ‰å¤´èƒ¸è…¹å’Œ6æ¡è…¿ã€‚èœ˜è››8æ¡è…¿ï¼Œèœˆèš£å¤šæ¡è…¿ï¼Œèœ—ç‰›æ˜¯è½¯ä½“åŠ¨ç‰©ã€‚" },
            
            // ç¬¬å››å•å…ƒï¼šç¹æ®–
            { unit: "ç¹æ®–", unitId: 4, q: "ç§å­å‘è‚²æˆæ ¹çš„éƒ¨åˆ†æ˜¯ï¼Ÿ", options: ["èƒšèŠ½", "èƒšæ ¹", "å­å¶", "ç§çš®"], a: 1, info: "èƒšæ ¹å‘æ ¹ï¼ŒèƒšèŠ½å‘èŒå¶ã€‚" },
            { unit: "ç¹æ®–", unitId: 4, q: "æ ¹çš„ç”Ÿé•¿æ–¹å‘æ€»æ˜¯ï¼Ÿ", options: ["å‘å…‰", "å‘ä¸‹", "å‘ä¸Š", "å‘æ°´"], a: 1, info: "æ ¹å…·æœ‰å‘åœ°æ€§ï¼Œå‘ä¸‹ç”Ÿé•¿ã€‚" },
            { unit: "ç¹æ®–", unitId: 4, q: "çŒ«çš„ç¹æ®–æ–¹å¼æ˜¯ï¼Ÿ", options: ["åµç”Ÿ", "èƒç”Ÿ", "åˆ†è£‚", "å‡ºèŠ½"], a: 1, info: "çŒ«æ˜¯å“ºä¹³åŠ¨ç‰©ï¼Œç›´æ¥ç”Ÿå°çŒ«ï¼Œä¸ºèƒç”Ÿã€‚" },
            { unit: "ç¹æ®–", unitId: 4, q: "ä¸‹åˆ—æ¤ç‰©ç”¨èŒç¹æ®–çš„æ˜¯ï¼Ÿ", options: ["çº¢è–¯", "ç”Ÿå§œ", "è½åœ°ç”Ÿæ ¹", "è¥¿ç“œ"], a: 1, info: "ç”Ÿå§œã€åœŸè±†ã€è²è—•éƒ½æ˜¯ç”¨èŒï¼ˆå—èŒ/æ ¹çŠ¶èŒï¼‰ç¹æ®–ã€‚" },
            { unit: "ç¹æ®–", unitId: 4, q: "é›„è›™é¸£å«æ˜¯ä¸ºäº†ï¼Ÿ", options: ["å“å”¬æ•Œäºº", "æ±‚å¶", "ç»ƒä¹ å”±æ­Œ", "å‘¼å”¤å­©å­"], a: 1, info: "é›„è›™é¸£å«æ˜¯æ±‚å¶è¡Œä¸ºï¼Œå±•ç¤ºå¼ºå¥ä½“é­„ã€‚" },
            { unit: "ç¹æ®–", unitId: 4, q: "å­”é›€å¼€å±å±äºä»€ä¹ˆè¡Œä¸ºï¼Ÿ", options: ["æ±‚å¶", "æ•é£Ÿ", "æ”»å‡»", "é˜²å¾¡"], a: 0, info: "é›„å­”é›€å¼€å±å¸å¼•é›Œå­”é›€ã€‚" },
            { unit: "ç¹æ®–", unitId: 4, q: "èš•è›¾ç¹æ®–åä»£çš„æ–¹å¼æ˜¯ï¼Ÿ", options: ["äº§åµ", "èƒç”Ÿ", "åˆ†è£‚", "ç§å­"], a: 0, info: "æ˜†è™«å¤šä¸ºåµç”Ÿã€‚" },
            { unit: "ç¹æ®–", unitId: 4, q: "å­å¶çš„ä¸»è¦ä½œç”¨æ˜¯ï¼Ÿ", options: ["å‘è‚²æˆå¶å­", "æä¾›è¥å…»", "ä¿æŠ¤èƒš", "å‘è‚²æˆæ ¹"], a: 1, info: "å­å¶å‚¨å­˜è¥å…»ï¼Œä¾›ç§å­èŒå‘ä½¿ç”¨ï¼Œä¹‹åä¼šæ¯èã€‚" },

            // ç¬¬äº”å•å…ƒï¼šç”Ÿç‰©ä¸ç¯å¢ƒ
            { unit: "ç”Ÿç‰©ç¯å¢ƒ", unitId: 5, q: "ä¸‹åˆ—ä¸å±äºç”Ÿç‰©çš„æ˜¯ï¼Ÿ", options: ["é’è‹”", "çŸ³ç¬‹", "ç»†èŒ", "è˜‘è‡"], a: 1, info: "çŸ³ç¬‹ä¸èƒ½è‡ªä¸»æ–°é™ˆä»£è°¢ï¼Œä¸æ˜¯ç”Ÿç‰©ã€‚" },
            { unit: "ç”Ÿç‰©ç¯å¢ƒ", unitId: 5, q: "é’è›™è¿‡å†¬çš„æ–¹å¼æ˜¯ï¼Ÿ", options: ["è¿å¾™", "å†¬çœ ", "æ¢æ¯›", "å‚¨å­˜é£Ÿç‰©"], a: 1, info: "å˜æ¸©åŠ¨ç‰©å¦‚è›‡ã€é’è›™å¤šé€‰æ‹©å†¬çœ ã€‚" },
            { unit: "ç”Ÿç‰©ç¯å¢ƒ", unitId: 5, q: "ç‡•å­å·¢ä¸»è¦ç”±ä»€ä¹ˆåˆ¶æˆï¼Ÿ", options: ["æ ‘æ", "æ³¥å’Œå”¾æ¶²", "ç¾½æ¯›", "èœ˜è››ç½‘"], a: 1, info: "ç‡•å­è¡”æ³¥ç­‘å·¢ã€‚" },
            { unit: "ç”Ÿç‰©ç¯å¢ƒ", unitId: 5, q: "è°æå‡ºäº†â€œå¤§é™†æ¼‚ç§»è¯´â€ï¼Ÿ", options: ["é­æ ¼çº³", "æå››å…‰", "è¾¾å°”æ–‡", "ç«ºå¯æ¡¢"], a: 0, info: "å¾·å›½ç§‘å­¦å®¶é­æ ¼çº³æå‡ºäº†å¤§é™†æ¼‚ç§»è¯´ã€‚" },
            { unit: "ç”Ÿç‰©ç¯å¢ƒ", unitId: 5, q: "æå››å…‰æ˜¯æˆ‘å›½è‘—åçš„ï¼Ÿ", options: ["å¤©æ–‡å­¦å®¶", "åœ°è´¨å­¦å®¶", "ç”Ÿç‰©å­¦å®¶", "æ•°å­¦å®¶"], a: 1, info: "æå››å…‰æ˜¯ä¸­å›½åœ°è´¨åŠ›å­¦çš„åˆ›ç«‹è€…ã€‚" },
            { unit: "ç”Ÿç‰©ç¯å¢ƒ", unitId: 5, q: "æ‘†çš„å¿«æ…¢ä¸ä»€ä¹ˆæœ‰å…³ï¼Ÿ", options: ["æ‘†é”¤è½»é‡", "æ‘†å¹…å¤§å°", "æ‘†çº¿é•¿çŸ­", "éƒ½æ— å…³"], a: 2, info: "æ‘†çº¿è¶Šé•¿æ‘†å¾—è¶Šæ…¢ï¼Œæ‘†çº¿è¶ŠçŸ­æ‘†å¾—è¶Šå¿«ï¼ˆå•æ‘†ç­‰æ—¶æ€§ï¼‰ã€‚" },
            { unit: "ç”Ÿç‰©ç¯å¢ƒ", unitId: 5, q: "é›·é¸Ÿå†¬å¤©æ¢ç¾½æ¯›æ˜¯ä¸ºäº†ï¼Ÿ", options: ["æ±‚å¶", "é€‚åº”ç¯å¢ƒ/ä¿æŠ¤è‰²", "é£è¡Œæ›´å¿«", "å“è·‘æ•Œäºº"], a: 1, info: "æ¢æˆç™½è‰²ç¾½æ¯›ä¸é›ªåœ°èä¸ºä¸€ä½“ï¼Œèº²é¿å¤©æ•Œã€‚" },
        ];

        // --- é…å¯¹æ¸¸æˆæ•°æ® ---
        const matchingData = [
            { id: 1, left: "èƒç”Ÿ", right: "çŒ«/ç‹—" },
            { id: 2, left: "åµç”Ÿ", right: "é¸¡/é±¼" },
            { id: 3, left: "ç”¨èŒç¹æ®–", right: "ç”Ÿå§œ/åœŸè±†" },
            { id: 4, left: "ç”¨æ ¹ç¹æ®–", right: "çº¢è–¯" },
            { id: 5, left: "å®Œå…¨å˜æ€", right: "èš•/è´è¶" },
            { id: 6, left: "å‡ç»“", right: "æ°´è’¸æ°”â†’æ°´" },
            { id: 7, left: "èåŒ–", right: "å†°â†’æ°´" },
            { id: 8, left: "æ’æ˜Ÿ", right: "å¤ªé˜³" },
            { id: 9, left: "å«æ˜Ÿ", right: "æœˆçƒ" },
            { id: 10, left: "å†¬çœ ", right: "é’è›™/è›‡" }
        ];

        // --- æ¸¸æˆçŠ¶æ€ ---
        let state = {
            mode: 'normal',
            difficulty: 'newbie',
            questions: [],
            currIdx: 0,
            score: 0,
            lives: 3,
            skips: 3,
            wrongAnswers: [],
            isMuted: false,
            
            // æ–°å¢çŠ¶æ€ï¼šç™¾åˆ†æ¯”è®¡ç®—ç›¸å…³
            correctCount: 0,
            totalQuestionsInSession: 0,
            
            // é…å¯¹æ¸¸æˆçŠ¶æ€
            matchItems: [],
            selectedItem: null,
            matchesLeft: 0,
            matchingMistakes: new Set() // è®°å½•é…å¯¹é”™è¯¯çš„ID
        };

        // --- éŸ³æ•ˆç³»ç»Ÿ ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (state.isMuted || audioCtx.state === 'suspended') {
                if(audioCtx.state === 'suspended') audioCtx.resume();
                if(state.isMuted) return;
            }
            
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'correct') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
                gainNode.gain.setValueAtTime(0.2, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'wrong') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.exponentialRampToValueAtTime(50, now + 0.3);
                gainNode.gain.setValueAtTime(0.2, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
                osc.start(now); osc.stop(now + 0.4);
            } else if (type === 'win') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.linearRampToValueAtTime(800, now + 0.5);
                gainNode.gain.setValueAtTime(0.2, now);
                gainNode.gain.linearRampToValueAtTime(0, now + 0.5);
                osc.start(now); osc.stop(now + 0.5);
            }
        }

        function toggleMute() {
            state.isMuted = !state.isMuted;
            document.getElementById('mute-icon').innerText = state.isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const icon = document.getElementById('theme-icon');
            icon.innerText = document.documentElement.classList.contains('dark') ? 'ğŸŒ™' : 'â˜€ï¸';
        }

        // --- æ ¸å¿ƒé€»è¾‘ ---

        function shuffle(arr) {
            return arr.sort(() => Math.random() - 0.5);
        }

        function resetGame() {
            hideAllScreens();
            document.getElementById('start-screen').classList.remove('hidden');
            document.getElementById('difficulty-modal').classList.add('hidden');
        }

        function hideAllScreens() {
            ['start-screen', 'game-screen', 'end-screen', 'matching-screen', 'difficulty-modal'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
        }

        function showDifficultySelect(mode) {
            if (mode === 'normal') {
                document.getElementById('difficulty-modal').classList.remove('hidden');
            } else {
                startGame(mode);
            }
        }
        function hideDifficultySelect() {
            document.getElementById('difficulty-modal').classList.add('hidden');
        }

        function startGame(mode, diff = 'newbie') {
            state.mode = mode;
            state.difficulty = diff;
            state.score = 0;
            state.currIdx = 0;
            state.lives = (mode === 'normal') ? 3 : 999;
            state.skips = 3;
            state.wrongAnswers = [];
            
            // Reset Percentage Stats
            state.correctCount = 0;
            state.totalQuestionsInSession = 0;
            state.matchingMistakes.clear();

            hideAllScreens();
            document.getElementById('game-screen').classList.remove('hidden');

            let qCount = 10;
            if (mode === 'infinite') qCount = fullQuestionBank.length;
            else if (diff === 'master') qCount = 20;
            else if (diff === 'scholar') qCount = fullQuestionBank.length;

            state.questions = shuffle([...fullQuestionBank]).slice(0, qCount);
            state.totalQuestionsInSession = qCount; // Set total for percentage calc

            updateStatus();
            loadQuestion();
        }

        function loadQuestion() {
            if (state.currIdx >= state.questions.length) {
                endGame();
                return;
            }

            const q = state.questions[state.currIdx];
            const ui = {
                text: document.getElementById('question-text'),
                options: document.getElementById('options-container'),
                tag: document.getElementById('unit-tag'),
                fb: document.getElementById('feedback-area')
            };

            ui.fb.classList.add('hidden');
            ui.text.innerText = q.q;
            
            const colors = ['bg-red-100 text-red-700', 'bg-blue-100 text-blue-700', 'bg-green-100 text-green-700', 'bg-purple-100 text-purple-700', 'bg-orange-100 text-orange-700'];
            ui.tag.className = `absolute -top-3 left-4 text-xs font-black px-3 py-1 rounded-full uppercase tracking-wide shadow-sm ${colors[(q.unitId-1)%5]}`;
            ui.tag.innerText = q.unit;

            ui.options.innerHTML = '';
            q.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = "option-btn w-full text-left p-4 rounded-xl font-bold bg-slate-50 dark:bg-slate-700/50 border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-200 flex items-center mb-2 hover:bg-blue-50 dark:hover:bg-slate-600";
                btn.innerHTML = `<span class="w-8 h-8 rounded-full bg-white dark:bg-slate-600 border dark:border-slate-500 text-center leading-8 mr-3 text-sm text-slate-400 font-black shadow-sm">${String.fromCharCode(65+i)}</span> ${opt}`;
                btn.onclick = () => checkAnswer(i, btn);
                ui.options.appendChild(btn);
            });

            const pct = (state.currIdx / state.questions.length) * 100;
            document.getElementById('progress-bar').style.width = `${pct}%`;
        }

        function checkAnswer(choiceIdx, btn) {
            if (!document.getElementById('feedback-area').classList.contains('hidden')) return;

            const q = state.questions[state.currIdx];
            const isCorrect = choiceIdx === q.a;

            if (isCorrect) {
                playSound('correct');
                state.score += 100; // Points stay for fun
                state.correctCount++; // For percentage
                btn.classList.add('bg-green-100', 'border-green-500', 'dark:bg-green-900', 'dark:border-green-600');
                setTimeout(() => {
                    state.currIdx++;
                    loadQuestion();
                    updateStatus();
                }, 800);
            } else {
                playSound('wrong');
                btn.classList.add('bg-red-100', 'border-red-500', 'shake', 'dark:bg-red-900', 'dark:border-red-600');
                state.lives--;
                state.wrongAnswers.push({ ...q, myChoice: q.options[choiceIdx] });
                
                const correctBtn = document.getElementById('options-container').children[q.a];
                correctBtn.classList.add('bg-green-100', 'border-green-500', 'dark:bg-green-900');
                
                document.getElementById('explanation-text').innerText = q.info;
                document.getElementById('feedback-area').classList.remove('hidden');
                
                if (state.mode === 'normal' && state.lives <= 0) {
                    document.getElementById('feedback-area').querySelector('button').innerText = "æŸ¥çœ‹ç»“æœ";
                    document.getElementById('feedback-area').querySelector('button').onclick = endGame;
                }
                updateStatus();
            }
        }

        function skipQuestion() {
            if (state.skips > 0) {
                state.skips--;
                state.currIdx++;
                updateStatus();
                loadQuestion();
            }
        }

        function nextQuestion() {
            if (state.lives <= 0 && state.mode === 'normal') {
                endGame();
            } else {
                state.currIdx++;
                loadQuestion();
            }
        }

        function updateStatus() {
            let hearts = state.mode === 'infinite' ? 'â™¾ï¸' : 'â¤ï¸'.repeat(state.lives);
            document.getElementById('lives-display').innerText = hearts;
            document.getElementById('score-display').innerText = state.score;
            document.getElementById('skips-left').innerText = state.skips;
            if(state.skips === 0) document.getElementById('skip-btn-container').classList.add('opacity-50', 'pointer-events-none');
        }

        function endGame() {
            hideAllScreens();
            document.getElementById('end-screen').classList.remove('hidden');
            
            // --- Percentage Logic ---
            let finalPercentage = 0;
            
            if (state.totalQuestionsInSession > 0) {
                // Quiz mode
                 finalPercentage = Math.round((state.correctCount / state.totalQuestionsInSession) * 100);
            } else {
                // Matching mode (fall back or fixed)
                // If it's purely matching mode, totalQuestionsInSession is 0.
                // We can calculate percentage based on matching mistakes if we want, or just set it to 100 minus penalty.
                // Let's assume Matching Mode starts with 100% and subtracts 10% per mistake (min 0).
                if (state.matchingMistakes.size > 0) {
                     finalPercentage = Math.max(0, 100 - (state.matchingMistakes.size * 10));
                } else {
                     finalPercentage = 100;
                }
            }

            document.getElementById('final-score').innerText = finalPercentage;
            
            // --- Matching Mistake Merge ---
            // If we have matching mistakes, convert them to "Wrong Answer" format and append.
            if (state.matchingMistakes.size > 0) {
                state.matchingMistakes.forEach(id => {
                    // Find the pair data
                    const pair = matchingData.find(p => p.id == id);
                    if (pair) {
                        state.wrongAnswers.push({
                            q: "é…å¯¹æ¦‚å¿µï¼š " + pair.left,
                            myChoice: "é…å¯¹é”™è¯¯",
                            options: ["æ­£ç¡®é…å¯¹ï¼š " + pair.right],
                            a: 0,
                            info: "éœ€é‡æ–°è®°å¿† [" + pair.left + "] ä¸ [" + pair.right + "] çš„å…³ç³»"
                        });
                    }
                });
            }

            const reviewBtn = document.getElementById('review-btn');
            const wrongCountBadge = document.getElementById('wrong-count-badge');
            
            if (state.wrongAnswers.length > 0) {
                reviewBtn.classList.remove('hidden');
                reviewBtn.classList.add('flex');
                wrongCountBadge.innerText = state.wrongAnswers.length;
            } else {
                reviewBtn.classList.add('hidden');
                reviewBtn.classList.remove('flex');
            }
            playSound('win');
        }

        // --- é”™é¢˜æœ¬ ---
        function showWrongAnswers() {
            const modal = document.getElementById('wrong-answers-modal');
            const list = document.getElementById('wrong-list');
            list.innerHTML = '';
            
            state.wrongAnswers.forEach((item, i) => {
                const div = document.createElement('div');
                div.className = "bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 relative overflow-hidden";
                
                // Card content
                div.innerHTML = `
                    <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-red-400"></div>
                    <div class="pl-4">
                        <div class="font-bold text-slate-800 dark:text-slate-200 mb-3 text-lg leading-snug">${i+1}. ${item.q}</div>
                        
                        <div class="flex flex-col gap-2 mb-3">
                            <div class="flex items-center gap-2 text-sm bg-red-50 dark:bg-red-900/20 p-2 rounded-lg text-red-600 dark:text-red-300">
                                <span class="font-bold shrink-0">âŒ ä½ çš„é€‰æ‹©:</span>
                                <span>${item.myChoice}</span>
                            </div>
                            <div class="flex items-center gap-2 text-sm bg-green-50 dark:bg-green-900/20 p-2 rounded-lg text-green-700 dark:text-green-300 border border-green-100 dark:border-green-800">
                                <span class="font-bold shrink-0">âœ… æ­£ç¡®ç­”æ¡ˆ:</span>
                                <span>${item.options ? item.options[item.a] : 'è§è§£æ'}</span>
                            </div>
                        </div>

                        <div class="text-xs bg-amber-50 dark:bg-amber-900/30 text-amber-800 dark:text-amber-200 p-3 rounded-xl border border-amber-100 dark:border-amber-800/50 flex items-start gap-2">
                            <span class="text-base mt-0.5">ğŸ’¡</span>
                            <span class="leading-relaxed">${item.info}</span>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
            modal.classList.remove('hidden');
        }

        function closeWrongAnswers() {
            document.getElementById('wrong-answers-modal').classList.add('hidden');
        }

        function showStartScreen() {
            resetGame();
        }

        // --- é…å¯¹æ¸¸æˆé€»è¾‘ ---
        function startMatchingGame() {
            // Reset state
            state.matchingMistakes.clear();
            state.totalQuestionsInSession = 0; // Means we are in matching mode

            hideAllScreens();
            document.getElementById('matching-screen').classList.remove('hidden');
            
            const subset = shuffle([...matchingData]).slice(0, 6);
            state.matchesLeft = 6;
            document.getElementById('match-pairs-left').innerText = 6;
            
            let cards = [];
            subset.forEach(item => {
                cards.push({ type: 'left', text: item.left, id: item.id });
                cards.push({ type: 'right', text: item.right, id: item.id });
            });
            cards = shuffle(cards);
            state.selectedItem = null;

            const grid = document.getElementById('matching-grid');
            grid.innerHTML = '';
            cards.forEach(card => {
                const el = document.createElement('button');
                el.className = "match-card bg-white dark:bg-slate-800 p-4 rounded-xl shadow border-2 border-slate-100 dark:border-slate-700 font-bold text-slate-700 dark:text-slate-200 h-24 flex items-center justify-center text-center text-sm break-words";
                el.innerText = card.text;
                el.dataset.id = card.id;
                el.onclick = () => handleMatchClick(el, card);
                grid.appendChild(el);
            });
        }

        function handleMatchClick(el, card) {
            if (el.classList.contains('opacity-0')) return; 
            if (state.selectedItem && state.selectedItem.el === el) {
                el.classList.remove('match-selected');
                state.selectedItem = null;
                return;
            }

            el.classList.add('match-selected');

            if (!state.selectedItem) {
                state.selectedItem = { el, card };
            } else {
                const prev = state.selectedItem;
                if (prev.card.id === card.id) {
                    // Correct
                    playSound('correct');
                    showMatchFeedback();
                    setTimeout(() => {
                        prev.el.classList.add('match-correct', 'opacity-0', 'pointer-events-none');
                        el.classList.add('match-correct', 'opacity-0', 'pointer-events-none');
                    }, 300);
                    state.matchesLeft--;
                    document.getElementById('match-pairs-left').innerText = state.matchesLeft;
                    
                    if (state.matchesLeft === 0) {
                        setTimeout(() => {
                            endGame();
                        }, 1000);
                    }
                } else {
                    // Wrong
                    playSound('wrong');
                    // Record Mistake (record the ID of the selected card)
                    // We record the ID of the card the user was trying to match (prev.card.id)
                    state.matchingMistakes.add(prev.card.id);
                    state.matchingMistakes.add(card.id); // Maybe user thought these two matched

                    prev.el.classList.add('shake', 'bg-red-50', 'dark:bg-red-900');
                    el.classList.add('shake', 'bg-red-50', 'dark:bg-red-900');
                    setTimeout(() => {
                        prev.el.classList.remove('match-selected', 'shake', 'bg-red-50', 'dark:bg-red-900');
                        el.classList.remove('match-selected', 'shake', 'bg-red-50', 'dark:bg-red-900');
                    }, 500);
                }
                state.selectedItem = null;
            }
        }

        function showMatchFeedback() {
            const fb = document.getElementById('match-feedback');
            fb.classList.remove('hidden');
            setTimeout(() => fb.classList.add('hidden'), 800);
        }

    </script>
</body>
</html>