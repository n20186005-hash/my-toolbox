<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="category" content="Text Tools">
    <meta name="icon" content="üîä">
    <title>Text to Speech Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { padding: 20px; background: #f0fdf4; font-family: sans-serif; }
        .tool-module { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 900px; margin: 0 auto; position: relative; }
        .section { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .form-group { margin-bottom: 10px; }
        label { display: block; font-size: 0.9rem; color: #4b5563; margin-bottom: 4px; }
        input, select, textarea { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem; }
        textarea { min-height: 150px; resize: vertical; }
        .result-card { background: #ecfdf5; border: 1px solid #d1fae5; border-radius: 8px; padding: 15px; margin-top: 15px; }
        .btn-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        button { padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: #10b981; color: white; border: none; }
        .btn-primary:hover { background: #059669; }
        .btn-secondary { background: #3b82f6; color: white; border: none; }
        .btn-secondary:hover { background: #2563eb; }
        .btn-danger { background: #ef4444; color: white; border: none; }
        .btn-danger:hover { background: #dc2626; }
        .intro-section { margin-top: 30px; padding: 20px; background-color: #f8fafc; border-radius: 8px; font-size: 0.95rem; color: #475569; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; }
        .badge-supported { background: #dcfce7; color: #166534; }
        .voice-preview { display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 6px; background: #f3f4f6; margin-bottom: 6px; cursor: pointer; }
        .voice-preview:hover { background: #e5e7eb; }
        .voice-active { background: #dbeafe; border: 1px solid #93c5fd; }
        /* Toast notification */
        .copy-notify { position: fixed; bottom: 20px; right: 20px; background: #10b981; color: white; padding: 10px 20px; border-radius: 4px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 50; }
    </style>
</head>
<body>

    <div class="tool-module" id="text-to-speech-tool">
        <!-- Language Selector -->
        <div class="absolute top-4 right-4">
            <select id="lang-selector" onchange="TTS.handleLangChange(this.value)" class="text-xs border border-gray-300 rounded p-1 bg-gray-50 text-gray-600 focus:outline-none">
                <option value="en" selected>English</option>
                <option value="zh-CN">ÁÆÄ‰Ωì‰∏≠Êñá</option>
                <option value="zh-TW">ÁπÅÈ´î‰∏≠Êñá</option>
                <option value="ja">Êó•Êú¨Ë™û</option>
                <option value="ru">–†—É—Å—Å–∫–∏–π</option>
            </select>
        </div>

        <h2 class="text-xl font-bold mb-6 text-gray-800 border-b pb-2" data-i18n="title">üîä Text to Speech Converter</h2>

        <div class="space-y-6">
            
            <!-- Text Input Section -->
            <div class="section">
                <h3 class="text-lg font-semibold mb-4 text-gray-700" data-i18n="input_section">Input Text</h3>
                <div class="form-group">
                    <label data-i18n="text_content">Text Content</label>
                    <textarea id="text_content" placeholder="Enter text to convert to speech" class="focus:ring-2 focus:ring-green-500 outline-none" data-i18n-placeholder="text_placeholder"></textarea>
                </div>
            </div>

            <!-- Voice Settings Section -->
            <div class="section">
                <h3 class="text-lg font-semibold mb-4 text-gray-700" data-i18n="voice_settings">Voice Settings</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label data-i18n="language">Language</label>
                        <select id="language" onchange="TTS.updateVoices()" class="focus:ring-2 focus:ring-green-500 outline-none">
                            <option value="en-US">English</option>
                            <option value="zh-CN">ÁÆÄ‰Ωì‰∏≠Êñá</option>
                            <option value="zh-TW">ÁπÅÈ´î‰∏≠Êñá</option>
                            <option value="ja-JP">Êó•Êú¨Ë™û</option>
                            <option value="ru-RU">–†—É—Å—Å–∫–∏–π</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="voice_type">Voice Type</label>
                        <select id="voice_type" onchange="TTS.updateVoicePreview()" class="focus:ring-2 focus:ring-green-500 outline-none">
                            <option value="default" data-i18n="default_voice">Default</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="speech_rate">Speech Rate (0.5-2)</label>
                        <input type="number" id="speech_rate" min="0.5" max="2" step="0.1" value="1" class="focus:ring-2 focus:ring-green-500 outline-none">
                    </div>
                    <div class="form-group">
                        <label data-i18n="pitch">Pitch (0-2)</label>
                        <input type="number" id="pitch" min="0" max="2" step="0.1" value="1" class="focus:ring-2 focus:ring-green-500 outline-none">
                    </div>
                </div>

                <div class="mt-4">
                    <label class="block mb-2" data-i18n="available_voices">Available Voices (Click to preview)</label>
                    <div id="voices_list" class="max-h-40 overflow-y-auto p-2 border border-gray-200 rounded">
                        <div class="text-gray-500 text-sm" data-i18n="loading_voices">Loading available voices...</div>
                    </div>
                </div>
            </div>

            <div class="btn-group">
                <button onclick="TTS.speak()" class="btn-primary" data-i18n="btn_speak">Speak</button>
                <button onclick="TTS.stop()" class="btn-danger" data-i18n="btn_stop">Stop</button>
                <!-- Changed from Audio Download to Text Download to ensure functionality -->
                <button onclick="TTS.downloadText()" class="btn-secondary" data-i18n="btn_download">Download Text (.txt)</button>
            </div>

            <!-- Result Section -->
            <div class="section">
                <h3 class="text-lg font-semibold mb-4 text-gray-700" data-i18n="status_title">Status</h3>
                <div class="result-card">
                    <div id="status_message" class="text-sm text-gray-600" data-i18n="no_audio">Ready to speak</div>
                </div>
            </div>

            <!-- Intro Section -->
            <div class="intro-section">
                <h3 class="text-lg font-semibold mb-2 text-gray-800" data-i18n="intro_title">About Text to Speech</h3>
                <p data-i18n="intro_text">This Text to Speech (TTS) tool converts written text into spoken audio using your browser's built-in speech synthesis capabilities. It supports multiple languages including English, Chinese, Japanese, and Russian. You can adjust speech rate, pitch, and choose different voices for a more natural listening experience.</p>
                <p class="mt-2 text-sm" data-i18n="intro_note">Note: Available voices may vary depending on your browser and operating system.</p>
            </div>
        </div>
    </div>

    <div id="copy-notify" class="copy-notify" data-i18n="download_success">File downloaded successfully!</div>

    <script>
        const TTS = {
            speechSynthesis: window.speechSynthesis,
            voices: [],
            currentUtterance: null,

            i18n: {
                'en': {
                    title: 'üîä Text to Speech Converter',
                    input_section: 'Input Text',
                    text_content: 'Text Content',
                    text_placeholder: 'Enter text to convert to speech',
                    voice_settings: 'Voice Settings',
                    language: 'Language',
                    voice_type: 'Voice Type',
                    default_voice: 'Default',
                    speech_rate: 'Speech Rate (0.5-2)',
                    pitch: 'Pitch (0-2)',
                    available_voices: 'Available Voices (Click to preview)',
                    loading_voices: 'Loading available voices...',
                    btn_speak: 'Speak',
                    btn_stop: 'Stop',
                    btn_download: 'Download Text (.txt)',
                    status_title: 'Status',
                    no_audio: 'Ready to speak',
                    intro_title: 'About Text to Speech',
                    intro_text: 'This Text to Speech (TTS) tool converts written text into spoken audio using your browser\'s built-in speech synthesis capabilities. It supports multiple languages including English, Chinese, Japanese, and Russian. You can adjust speech rate, pitch, and choose different voices for a more natural listening experience.',
                    intro_note: 'Note: Available voices may vary depending on your browser and operating system. Direct audio file download is not supported by most browsers.',
                    download_success: 'File downloaded successfully!',
                    no_voices: 'No voices available for this language'
                },
                'zh-CN': {
                    title: 'üîä ÊñáÂ≠óËΩ¨ËØ≠Èü≥Â∑•ÂÖ∑',
                    input_section: 'ËæìÂÖ•ÊñáÊú¨',
                    text_content: 'ÊñáÊú¨ÂÜÖÂÆπ',
                    text_placeholder: 'ËæìÂÖ•Ë¶ÅËΩ¨Êç¢‰∏∫ËØ≠Èü≥ÁöÑÊñáÂ≠ó',
                    voice_settings: 'ËØ≠Èü≥ËÆæÁΩÆ',
                    language: 'ËØ≠Ë®Ä',
                    voice_type: 'ËØ≠Èü≥Á±ªÂûã',
                    default_voice: 'ÈªòËÆ§',
                    speech_rate: 'ËØ≠ÈÄü (0.5-2)',
                    pitch: 'Èü≥Ë∞É (0-2)',
                    available_voices: 'ÂèØÁî®ËØ≠Èü≥ (ÁÇπÂáªÈ¢ÑËßà)',
                    loading_voices: 'Âä†ËΩΩÂèØÁî®ËØ≠Èü≥‰∏≠...',
                    btn_speak: 'Êí≠Êîæ',
                    btn_stop: 'ÂÅúÊ≠¢',
                    btn_download: '‰∏ãËΩΩÊñáÊú¨ (.txt)',
                    status_title: 'Áä∂ÊÄÅ',
                    no_audio: 'ÂáÜÂ§áÂ∞±Áª™',
                    intro_title: 'ÂÖ≥‰∫éÊñáÂ≠óËΩ¨ËØ≠Èü≥',
                    intro_text: 'ËøôÊ¨æÊñáÂ≠óËΩ¨ËØ≠Èü≥ÔºàTTSÔºâÂ∑•ÂÖ∑Âà©Áî®ÊµèËßàÂô®ÂÜÖÁΩÆÁöÑËØ≠Èü≥ÂêàÊàêÂäüËÉΩÔºåÂ∞Ü‰π¶Èù¢ÊñáÊú¨ËΩ¨Êç¢‰∏∫ÊúâÂ£∞Èü≥È¢ë„ÄÇÂÆÉÊîØÊåÅÂ§öÁßçËØ≠Ë®ÄÔºåÂåÖÊã¨Ëã±ËØ≠„ÄÅ‰∏≠Êñá„ÄÅÊó•ËØ≠Âíå‰øÑËØ≠„ÄÇÊÇ®ÂèØ‰ª•Ë∞ÉÊï¥ËØ≠ÈÄü„ÄÅÈü≥Ë∞ÉÂíåÈÄâÊã©‰∏çÂêåÁöÑÂ£∞Èü≥Ôºå‰ª•Ëé∑ÂæóÊõ¥Ëá™ÁÑ∂ÁöÑËÅÜÂê¨‰ΩìÈ™å„ÄÇ',
                    intro_note: 'Ê≥®ÊÑèÔºöÂèØÁî®ÁöÑËØ≠Èü≥ÂèØËÉΩÂõ†ÊµèËßàÂô®ÂíåÊìç‰ΩúÁ≥ªÁªüËÄåÂºÇ„ÄÇÂ§ßÂ§öÊï∞ÊµèËßàÂô®‰∏çÊîØÊåÅÁõ¥Êé•‰∏ãËΩΩÂêàÊàêÁöÑÈü≥È¢ëÊñá‰ª∂„ÄÇ',
                    download_success: 'Êñá‰ª∂‰∏ãËΩΩÊàêÂäüÔºÅ',
                    no_voices: 'ËØ•ËØ≠Ë®ÄÊöÇÊó†ÂèØÁî®ËØ≠Èü≥'
                },
                'zh-TW': {
                    title: 'üîä ÊñáÂ≠óËΩâË™ûÈü≥Â∑•ÂÖ∑',
                    input_section: 'Ëº∏ÂÖ•ÊñáÊú¨',
                    text_content: 'ÊñáÊú¨ÂÖßÂÆπ',
                    text_placeholder: 'Ëº∏ÂÖ•Ë¶ÅËΩâÊèõÁÇ∫Ë™ûÈü≥ÁöÑÊñáÂ≠ó',
                    voice_settings: 'Ë™ûÈü≥Ë®≠ÂÆö',
                    language: 'Ë™ûË®Ä',
                    voice_type: 'Ë™ûÈü≥È°ûÂûã',
                    default_voice: 'ÈªòË™ç',
                    speech_rate: 'Ë™ûÈÄü (0.5-2)',
                    pitch: 'Èü≥Ë™ø (0-2)',
                    available_voices: 'ÂèØÁî®Ë™ûÈü≥ (ÈªûÊìäÈ†êË¶Ω)',
                    loading_voices: 'Âä†ËºâÂèØÁî®Ë™ûÈü≥‰∏≠...',
                    btn_speak: 'Êí≠Êîæ',
                    btn_stop: 'ÂÅúÊ≠¢',
                    btn_download: '‰∏ãËºâÊñáÊú¨ (.txt)',
                    status_title: 'ÁãÄÊÖã',
                    no_audio: 'Ê∫ñÂÇôÂ∞±Á∑í',
                    intro_title: 'ÈóúÊñºÊñáÂ≠óËΩâË™ûÈü≥',
                    intro_text: 'ÈÄôÊ¨æÊñáÂ≠óËΩâË™ûÈü≥ÔºàTTSÔºâÂ∑•ÂÖ∑Âà©Áî®ÁÄèË¶ΩÂô®ÂÖßÁΩÆÁöÑË™ûÈü≥ÂêàÊàêÂäüËÉΩÔºåÂ∞áÊõ∏Èù¢ÊñáÊú¨ËΩâÊèõÁÇ∫ÊúâËÅ≤Èü≥È†ª„ÄÇÂÆÉÊîØÊåÅÂ§öÁ®ÆË™ûË®ÄÔºåÂåÖÊã¨Ëã±Ë™û„ÄÅ‰∏≠Êñá„ÄÅÊó•Ë™ûÂíå‰øÑË™û„ÄÇÊÇ®ÂèØ‰ª•Ë™øÊï¥Ë™ûÈÄü„ÄÅÈü≥Ë™øÂíåÈÅ∏Êìá‰∏çÂêåÁöÑËÅ≤Èü≥Ôºå‰ª•Áç≤ÂæóÊõ¥Ëá™ÁÑ∂ÁöÑËÅÜËÅΩÈ´îÈ©ó„ÄÇ',
                    intro_note: 'Ê≥®ÊÑèÔºöÂèØÁî®ÁöÑË™ûÈü≥ÂèØËÉΩÂõ†ÁÄèË¶ΩÂô®ÂíåÊìç‰ΩúÁ≥ªÁµ±ËÄåÁï∞„ÄÇÂ§ßÂ§öÊï∏ÁÄèË¶ΩÂô®‰∏çÊîØÊåÅÁõ¥Êé•‰∏ãËºâÂêàÊàêÁöÑÈü≥È†ªÊñá‰ª∂„ÄÇ',
                    download_success: 'Êñá‰ª∂‰∏ãËºâÊàêÂäüÔºÅ',
                    no_voices: 'Ë©≤Ë™ûË®ÄÊö´ÁÑ°ÂèØÁî®Ë™ûÈü≥'
                },
                'ja': {
                    title: 'üîä „ÉÜ„Ç≠„Çπ„ÉàË™≠„Åø‰∏ä„Åí„ÉÑ„Éº„É´',
                    input_section: '„ÉÜ„Ç≠„Çπ„ÉàÂÖ•Âäõ',
                    text_content: '„ÉÜ„Ç≠„Çπ„ÉàÂÜÖÂÆπ',
                    text_placeholder: 'Èü≥Â£∞„Å´Â§âÊèõ„Åô„Çã„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ',
                    voice_settings: 'Èü≥Â£∞Ë®≠ÂÆö',
                    language: 'Ë®ÄË™û',
                    voice_type: 'Èü≥Â£∞„Çø„Ç§„Éó',
                    default_voice: '„Éá„Éï„Ç©„É´„Éà',
                    speech_rate: 'Ë©±ÈÄü (0.5-2)',
                    pitch: '„Éî„ÉÉ„ÉÅ (0-2)',
                    available_voices: 'Âà©Áî®ÂèØËÉΩ„Å™Èü≥Â£∞ („ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Éó„É¨„Éì„É•„Éº)',
                    loading_voices: 'Âà©Áî®ÂèØËÉΩ„Å™Èü≥Â£∞„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...',
                    btn_speak: 'ÂÜçÁîü',
                    btn_stop: 'ÂÅúÊ≠¢',
                    btn_download: '„ÉÜ„Ç≠„Çπ„Éà„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ (.txt)',
                    status_title: '„Çπ„ÉÜ„Éº„Çø„Çπ',
                    no_audio: 'Ê∫ñÂÇôÂÆå‰∫Ü',
                    intro_title: '„ÉÜ„Ç≠„Çπ„ÉàË™≠„Åø‰∏ä„Åí„Å´„Å§„ÅÑ„Å¶',
                    intro_text: '„Åì„ÅÆ„ÉÜ„Ç≠„Çπ„ÉàË™≠„Åø‰∏ä„ÅíÔºàTTSÔºâ„ÉÑ„Éº„É´„ÅØ„ÄÅ„Éñ„É©„Ç¶„Ç∂„ÅÆÁµÑ„ÅøËæº„ÅøÈü≥Â£∞ÂêàÊàêÊ©üËÉΩ„Çí‰ΩøÁî®„Åó„Å¶„ÄÅÊõ∏„Åã„Çå„Åü„ÉÜ„Ç≠„Çπ„Éà„ÇíÈü≥Â£∞„Å´Â§âÊèõ„Åó„Åæ„Åô„ÄÇËã±Ë™û„ÄÅ‰∏≠ÂõΩË™û„ÄÅÊó•Êú¨Ë™û„ÄÅ„É≠„Ç∑„Ç¢Ë™û„Å™„Å©Ë§áÊï∞„ÅÆË®ÄË™û„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇË©±ÈÄü„ÄÅ„Éî„ÉÉ„ÉÅ„ÇíË™øÊï¥„Åó„Åü„Çä„ÄÅ„Åï„Åæ„Åñ„Åæ„Å™Èü≥Â£∞„ÇíÈÅ∏Êäû„Åó„Åü„Çä„Åó„Å¶„ÄÅ„Çà„ÇäËá™ÁÑ∂„Å™ËÅ¥Âèñ‰ΩìÈ®ì„ÇíÂæó„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ',
                    intro_note: 'Ê≥®ÔºöÂà©Áî®ÂèØËÉΩ„Å™Èü≥Â£∞„ÅØ„ÄÅ„Éñ„É©„Ç¶„Ç∂„Å®„Ç™„Éö„É¨„Éº„ÉÜ„Ç£„É≥„Ç∞„Ç∑„Çπ„ÉÜ„É†„Å´„Çà„Å£„Å¶Áï∞„Å™„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ„Åª„Å®„Çì„Å©„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÈü≥Â£∞„Éï„Ç°„Ç§„É´„ÅÆÁõ¥Êé•„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Çí„Çµ„Éù„Éº„Éà„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ',
                    download_success: '„Éï„Ç°„Ç§„É´„ÅÆ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„ÅåÊàêÂäü„Åó„Åæ„Åó„ÅüÔºÅ',
                    no_voices: '„Åì„ÅÆË®ÄË™û„ÅßÂà©Áî®ÂèØËÉΩ„Å™Èü≥Â£∞„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì'
                },
                'ru': {
                    title: 'üîä –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä —Ç–µ–∫—Å—Ç–∞ –≤ —Ä–µ—á—å',
                    input_section: '–í—Ö–æ–¥–Ω–æ–π —Ç–µ–∫—Å—Ç',
                    text_content: '–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–µ–∫—Å—Ç–∞',
                    text_placeholder: '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≤ —Ä–µ—á—å',
                    voice_settings: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–æ–ª–æ—Å–∞',
                    language: '–Ø–∑—ã–∫',
                    voice_type: '–¢–∏–ø –≥–æ–ª–æ—Å–∞',
                    default_voice: '–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é',
                    speech_rate: '–°–∫–æ—Ä–æ—Å—Ç—å —Ä–µ—á–∏ (0.5-2)',
                    pitch: '–¢–æ–Ω (0-2)',
                    available_voices: '–î–æ—Å—Ç—É–ø–Ω—ã–µ –≥–æ–ª–æ—Å–∞ (—â–µ–ª–∫–Ω–∏—Ç–µ –¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞)',
                    loading_voices: '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥–æ–ª–æ—Å–æ–≤...',
                    btn_speak: '–ü—Ä–æ–∏–≥—Ä–∞—Ç—å',
                    btn_stop: '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å',
                    btn_download: '–°–∫–∞—á–∞—Ç—å —Ç–µ–∫—Å—Ç (.txt)',
                    status_title: '–°—Ç–∞—Ç—É—Å',
                    no_audio: '–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ',
                    intro_title: '–û —Ç–µ–∫—Å—Ç–µ –≤ —Ä–µ—á—å',
                    intro_text: '–≠—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ —Ä–µ—á—å (TTS) –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –ø–∏—Å—å–º–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ –ø—Ä–æ–∏–∑–Ω–æ—Å–∏–º—ã–π –∞—É–¥–∏–æ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏ –±—Ä–∞—É–∑–µ—Ä–∞. –û–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —è–∑—ã–∫–æ–≤, –≤–∫–ª—é—á–∞—è –∞–Ω–≥–ª–∏–π—Å–∫–∏–π, –∫–∏—Ç–∞–π—Å–∫–∏–π, —è–ø–æ–Ω—Å–∫–∏–π –∏ —Ä—É—Å—Å–∫–∏–π. –í—ã –º–æ–∂–µ—Ç–µ —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–µ—á–∏, —Ç–æ–Ω –∏ –≤—ã–±–∏—Ä–∞—Ç—å —Ä–∞–∑–Ω—ã–µ –≥–æ–ª–æ—Å–∞ –¥–ª—è –±–æ–ª–µ–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è.',
                    intro_note: '–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –î–æ—Å—Ç—É–ø–Ω—ã–µ –≥–æ–ª–æ—Å–∞ –º–æ–≥—É—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∞—à–µ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞ –∏ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã. –ü—Ä—è–º–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.',
                    download_success: '–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω!',
                    no_voices: '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥–æ–ª–æ—Å–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ —è–∑—ã–∫–∞'
                }
            },

            init: function() {
                // Initialize voices when loaded
                if (window.speechSynthesis.onvoiceschanged !== undefined) {
                    window.speechSynthesis.onvoiceschanged = () => {
                        this.voices = window.speechSynthesis.getVoices();
                        this.updateVoices();
                    };
                }
                
                // Trigger voice loading immediately as well
                this.voices = window.speechSynthesis.getVoices();
                
                // Check URL for language parameter
                this.checkUrlParams();
            },

            checkUrlParams: function() {
                const urlParams = new URLSearchParams(window.location.search);
                const langParam = urlParams.get('lang');
                
                // If there is a valid lang param, set it
                if (langParam && this.i18n[langParam]) {
                    document.getElementById('lang-selector').value = langParam;
                    this.applyLang(langParam);
                } else {
                    // Default to English if no param
                    this.applyLang('en');
                }
            },

            handleLangChange: function(lang) {
                // Update URL parameter with try-catch to avoid SecurityError in sandboxed environments
                try {
                    const url = new URL(window.location);
                    url.searchParams.set('lang', lang);
                    window.history.pushState({}, '', url);
                } catch (e) {
                    console.log('Cannot update URL in this environment', e);
                }
                
                this.applyLang(lang);
            },

            // FIX: Added shouldUpdateVoices parameter to prevent infinite recursion
            applyLang: function(lang, shouldUpdateVoices = true) {
                // Update UI text
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (this.i18n[lang] && this.i18n[lang][key]) {
                        el.textContent = this.i18n[lang][key];
                    }
                });
                
                // Update placeholders
                document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                    const key = el.getAttribute('data-i18n-placeholder');
                    if (this.i18n[lang] && this.i18n[lang][key]) {
                        el.placeholder = this.i18n[lang][key];
                    }
                });

                // Update voice language selector based on UI language
                // Only do this if shouldUpdateVoices is true
                if (shouldUpdateVoices) {
                    const langMap = {
                        'en': 'en-US',
                        'zh-CN': 'zh-CN',
                        'zh-TW': 'zh-TW',
                        'ja': 'ja-JP',
                        'ru': 'ru-RU'
                    };
                    if (langMap[lang]) {
                        document.getElementById('language').value = langMap[lang];
                        this.updateVoices();
                    }
                }
            },

            updateVoices: function() {
                // Retry getting voices if empty (sometimes happens on first load in Chrome)
                if (this.voices.length === 0) {
                    this.voices = window.speechSynthesis.getVoices();
                }

                const lang = document.getElementById('language').value;
                const voiceSelect = document.getElementById('voice_type');
                const voicesList = document.getElementById('voices_list');
                const uiLang = document.getElementById('lang-selector').value;
                
                // Clear existing options
                voiceSelect.innerHTML = '<option value="default" data-i18n="default_voice">Default</option>';
                voicesList.innerHTML = '';
                
                // Filter voices by language
                const filteredVoices = this.voices.filter(voice => 
                    voice.lang.startsWith(lang) || voice.lang.split('-')[0] === lang.split('-')[0]
                );
                
                if (filteredVoices.length === 0) {
                    const noVoiceMsg = this.i18n[uiLang]['no_voices'] || 'No voices available';
                    voicesList.innerHTML = `<div class="text-gray-500 text-sm">${noVoiceMsg}</div>`;
                    
                    // FIX: Pass false to prevent recursion
                    this.applyLang(uiLang, false);
                    return;
                }
                
                // Populate voice select and preview list
                filteredVoices.forEach(voice => {
                    // Add to select dropdown
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    voiceSelect.appendChild(option);
                    
                    // Add to preview list
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'voice-preview';
                    previewDiv.innerHTML = `
                        <span>${voice.name}</span>
                        <span class="badge badge-supported text-xs">${voice.lang}</span>
                    `;
                    previewDiv.addEventListener('click', () => {
                        // Remove active class from all
                        document.querySelectorAll('.voice-preview').forEach(el => 
                            el.classList.remove('voice-active')
                        );
                        // Add active class to clicked
                        previewDiv.classList.add('voice-active');
                        // Set selected voice
                        voiceSelect.value = voice.name;
                        // Preview voice
                        this.previewVoice(voice);
                    });
                    voicesList.appendChild(previewDiv);
                });
                
                // FIX: Pass false to prevent recursion
                // We re-apply translations to ensure "Default" is translated, but don't trigger voice update again
                this.applyLang(uiLang, false);
            },

            updateVoicePreview: function() {
                const voiceName = document.getElementById('voice_type').value;
                if (voiceName === 'default') return;
                
                const voice = this.voices.find(v => v.name === voiceName);
                if (voice) {
                    this.previewVoice(voice);
                }
            },

            previewVoice: function(voice) {
                const sampleText = {
                    'en-US': 'This is a voice preview.',
                    'zh-CN': 'ËøôÊòØ‰∏Ä‰∏™ËØ≠Èü≥È¢ÑËßà„ÄÇ',
                    'zh-TW': 'ÈÄôÊòØ‰∏ÄÂÄãË™ûÈü≥È†êË¶Ω„ÄÇ',
                    'ja-JP': '„Åì„Çå„ÅØÈü≥Â£∞„Éó„É¨„Éì„É•„Éº„Åß„Åô„ÄÇ',
                    'ru-RU': '–≠—Ç–æ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –≥–æ–ª–æ—Å–∞.'
                };
                
                const lang = document.getElementById('language').value;
                const text = sampleText[lang] || 'Voice preview.';
                
                this.speakText(text, voice);
            },

            speak: function() {
                const text = document.getElementById('text_content').value.trim();
                if (!text) {
                    alert('Please enter some text to speak');
                    return;
                }
                
                const voiceName = document.getElementById('voice_type').value;
                const rate = parseFloat(document.getElementById('speech_rate').value);
                const pitch = parseFloat(document.getElementById('pitch').value);
                
                let voice = null;
                if (voiceName !== 'default') {
                    voice = this.voices.find(v => v.name === voiceName);
                }
                
                this.speakText(text, voice, rate, pitch);
            },

            speakText: function(text, voice, rate = 1, pitch = 1) {
                // Stop any ongoing speech first - CRITICAL FIX
                this.stop();
                
                // Create new utterance
                this.currentUtterance = new SpeechSynthesisUtterance(text);
                
                // Set voice properties
                if (voice) this.currentUtterance.voice = voice;
                this.currentUtterance.rate = rate;
                this.currentUtterance.pitch = pitch;
                
                // Update status
                const statusMsg = document.getElementById('status_message');
                statusMsg.textContent = 'Speaking...';
                
                // Handle events
                this.currentUtterance.onend = () => {
                    statusMsg.textContent = 'Playback finished';
                };
                
                this.currentUtterance.onerror = (e) => {
                    console.error('Speech error:', e);
                    statusMsg.textContent = 'Error occurred during playback';
                };
                
                // Speak
                this.speechSynthesis.speak(this.currentUtterance);
            },

            stop: function() {
                if (this.speechSynthesis.speaking || this.speechSynthesis.pending) {
                    this.speechSynthesis.cancel();
                    document.getElementById('status_message').textContent = 'Playback stopped';
                }
                this.currentUtterance = null;
            },

            // REPAIR: Changed from simulated audio download to functional text download
            downloadText: function() {
                const text = document.getElementById('text_content').value.trim();
                if (!text) {
                    alert('Please enter some text first');
                    return;
                }
                
                // Create blob and download
                const blob = new Blob([text], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'speech-text.txt';
                document.body.appendChild(a);
                a.click();
                
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                // Show success notification
                const notify = document.getElementById('copy-notify');
                notify.style.opacity = '1';
                setTimeout(() => notify.style.opacity = '0', 2000);
            }
        };

        // Initialize the TTS tool when page loads
        window.onload = () => {
            TTS.init();
        };
    </script>
</body>
</html>