<!DOCTYPE html>
<html lang="zh-TW" class="transition-colors duration-200">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="category" content="finance">
    <title>Calcure - Advanced Calculator</title>
    
    <!-- ÈÖçÁΩÆ Tailwind ‰ª•ÊîØÊåÅ class Ê®°ÂºèÁöÑÊ∑±Ëâ≤‰∏ªÈ°å -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b', 
                            900: '#0f172a',
                            950: '#020617',
                        }
                    }
                }
            }
        }
    </script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/mathjs@11.8.2/dist/math.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', 'Meiryo', sans-serif; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Inputs & Buttons */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .calc-btn { transition: all 0.15s; }
        .calc-btn:active { transform: scale(0.95); }
        .input-group:focus-within { transform: translateY(-1px); }

        /* Scrollbar */
        .custom-scroll::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        
        /* Dark mode scrollbar */
        .dark .custom-scroll::-webkit-scrollbar-thumb { background: #475569; }
        .dark .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }

        /* Toast Notification */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 50; pointer-events: none; }
        .toast { pointer-events: auto; padding: 10px 20px; border-radius: 8px; color: white; margin-bottom: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); animation: slideDown 0.3s ease-out; font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 8px; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .toast.error { background-color: #ef4444; }
        .toast.success { background-color: #10b981; }

        /* Math display */
        .math-expression { font-size: 1.1rem; padding: 10px; border-radius: 8px; }
        .math-result { font-size: 1.25rem; font-weight: 600; color: #3b82f6; }
    </style>
</head>
<body class="p-0 md:p-6 min-h-screen flex flex-col text-slate-800 bg-slate-50 dark:bg-slate-950 dark:text-slate-200 transition-colors duration-200">
    <!-- Toast Container -->
    <div id="toast-container"></div>

    <div class="max-w-7xl mx-auto w-full flex-grow flex flex-col">
        <!-- Header -->
        <div class="bg-white dark:bg-slate-900 rounded-none md:rounded-2xl shadow-sm border-b md:border border-slate-200 dark:border-slate-800 mb-0 md:mb-6 sticky top-0 z-30 transition-colors duration-200">
            <div class="flex flex-col md:flex-row justify-between items-center p-4 md:px-6">
                <!-- Logo -->
                <div class="flex items-center gap-3 w-full md:w-auto mb-4 md:mb-0">
                    <div class="bg-gradient-to-br from-purple-600 to-indigo-700 text-white p-2.5 rounded-xl shadow-lg shadow-purple-500/20">
                        <i class="fa-solid fa-calculator text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-slate-800 dark:text-white leading-tight" data-i18n="app_title">calcure</h1>
                        <p class="text-xs text-slate-400 dark:text-slate-500 font-medium" data-i18n="app_subtitle">Advanced Mathematical Calculator</p>
                    </div>
                </div>

                <!-- Language & Theme -->
                <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                    <div class="relative w-full sm:w-40">
                        <select id="lang-select" onchange="I18nModule.changeLanguage(this.value)" class="w-full sm:w-40 appearance-none bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-200 text-sm rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 block p-2.5 cursor-pointer font-medium hover:border-purple-300 transition shadow-sm">
                            <option value="en">üá∫üá∏ English</option>
                            <option value="zh-CN">üá®üá≥ ÁÆÄ‰Ωì‰∏≠Êñá</option>
                            <option value="zh-TW">üá≠üá∞ ÁπÅÈ´î‰∏≠Êñá</option>
                            <option value="ja">üáØüáµ Êó•Êú¨Ë™û</option>
                            <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-500">
                            <i class="fa-solid fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                    
                    <button id="theme-toggle" class="w-full sm:w-auto bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-200 text-sm rounded-xl p-2.5 cursor-pointer font-medium hover:border-purple-300 dark:hover:border-purple-500 transition shadow-sm flex items-center justify-center gap-2">
                        <i class="fa-solid fa-moon"></i>
                        <span data-i18n="dark_mode">Dark Mode</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="bg-white dark:bg-slate-900 md:rounded-3xl shadow-xl shadow-slate-200/50 dark:shadow-black/20 border border-slate-100 dark:border-slate-800 overflow-hidden flex-grow relative transition-colors duration-200">
            <div id="calculator-view" class="fade-in p-6 md:p-10 h-full">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 h-full">
                    <!-- Calculator Input & Results -->
                    <div class="lg:col-span-7 space-y-6">
                        <!-- Calculation Area -->
                        <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm transition-colors duration-200">
                            <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
                                <span class="bg-purple-600 text-white w-8 h-8 rounded-lg flex items-center justify-center text-sm"><i class="fa-solid fa-calculator"></i></span>
                                <span data-i18n="calculation_area">Calculation Area</span>
                            </h3>
                            
                            <div class="space-y-4">
                                <div class="relative">
                                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1.5" data-i18n="expression">Mathematical Expression</label>
                                    <div class="flex">
                                        <input type="text" id="math-expression" placeholder="e.g. 2 + 3 * sin(œÄ/4), det([[1,2],[3,4]]), derivative(x^2, x)" 
                                            class="flex-grow pl-4 pr-4 py-3 border border-slate-200 dark:border-slate-700 rounded-l-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-100 font-medium placeholder-slate-400">
                                        <button onclick="CalcModule.calculate()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-r-xl shadow-md shadow-purple-600/20 transition-all">
                                            <i class="fa-solid fa-equals"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1.5" data-i18n="result">Result</label>
                                    <div class="math-result bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl border border-slate-200 dark:border-slate-700 min-h-[60px] text-blue-500 dark:text-blue-400" id="calculation-result">
                                        <span class="text-slate-400 dark:text-slate-500 font-normal text-base" data-i18n="result_placeholder">Enter an expression and click = to calculate</span>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1.5" data-i18n="steps">Calculation Steps</label>
                                    <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl border border-slate-200 dark:border-slate-700 max-h-[150px] overflow-auto custom-scroll text-sm text-slate-700 dark:text-slate-300" id="calculation-steps">
                                        <span class="text-slate-400 dark:text-slate-500" data-i18n="steps_placeholder">Steps will be shown here</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Graph Plotter -->
                        <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm transition-colors duration-200">
                            <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
                                <span class="bg-blue-600 text-white w-8 h-8 rounded-lg flex items-center justify-center text-sm"><i class="fa-solid fa-chart-line"></i></span>
                                <span data-i18n="graph_plotter">Graph Plotter</span>
                            </h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1.5" data-i18n="function">Function (y = ...)</label>
                                    <input type="text" id="function-expression" placeholder="e.g. x^2, sin(x), e^(-x^2)" 
                                        class="w-full pl-4 pr-4 py-3 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-100 font-medium placeholder-slate-400">
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1.5" data-i18n="x_min">X Minimum</label>
                                        <input type="number" id="x-min" value="-10" step="0.5"
                                            class="w-full pl-4 pr-4 py-3 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-100 font-medium">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1.5" data-i18n="x_max">X Maximum</label>
                                        <input type="number" id="x-max" value="10" step="0.5"
                                            class="w-full pl-4 pr-4 py-3 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-100 font-medium">
                                    </div>
                                </div>
                                
                                <button onclick="GraphModule.plot()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-md shadow-blue-600/20 transition-all flex justify-center items-center gap-2">
                                    <i class="fa-solid fa-pen-to-square"></i> <span data-i18n="plot_graph">Plot Graph</span>
                                </button>
                                
                                <div class="h-[300px] relative bg-slate-50 dark:bg-slate-800/30 rounded-xl border border-slate-200 dark:border-slate-800 p-2">
                                    <canvas id="function-graph" class="w-full h-full"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Calculator Functions & Notes -->
                    <div class="lg:col-span-5 space-y-6">
                        <!-- Function Buttons -->
                        <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm transition-colors duration-200">
                            <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
                                <span class="bg-green-600 text-white w-8 h-8 rounded-lg flex items-center justify-center text-sm"><i class="fa-solid fa-braces"></i></span>
                                <span data-i18n="functions">Functions</span>
                            </h3>
                            
                            <div class="grid grid-cols-3 gap-2 mb-4">
                                <button onclick="CalcModule.insertFunction('sin(')" class="calc-btn bg-slate-50 dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-800 dark:text-slate-200 py-2 rounded-lg border border-slate-200 dark:border-slate-700 text-sm">sin(</button>
                                <button onclick="CalcModule.insertFunction('cos(')" class="calc-btn bg-slate-50 dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-800 dark:text-slate-200 py-2 rounded-lg border border-slate-200 dark:border-slate-700 text-sm">cos(</button>
                                <button onclick="CalcModule.insertFunction('tan(')" class="calc-btn bg-slate-50 dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-800 dark:text-slate-200 py-2 rounded-lg border border-slate-200 dark:border-slate-700 text-sm">tan(</button>
                                <button onclick="CalcModule.insertFunction('log(')" class="calc-btn bg-slate-50 dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-800 dark:text-slate-200 py-2 rounded-lg border border-slate-200 dark:border-slate-700 text-sm">log(</button>
                                <button onclick="CalcModule.insertFunction('ln(')" class="calc-btn bg-slate-50 dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-800 dark:text-slate-200 py-2 rounded-lg border border-slate-200 dark:border-slate-700 text-sm">ln(</button>
                                <button onclick="CalcModule.insertFunction('sqrt(')" class="calc-btn bg-slate-50 dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-800 dark:text-slate-200 py-2 rounded-lg border border-slate-200 dark:border-slate-700 text-sm">sqrt(</button>
                                <button onclick="CalcModule.insertFunction('^')" class="calc-btn bg-slate-50 dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-800 dark:text-slate-200 py-2 rounded-lg border border-slate-200 dark:border-slate-700 text-sm">^</button>
                                <button onclick="CalcModule.insertFunction('!')" class="calc-btn bg-slate-50 dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-800 dark:text-slate-200 py-2 rounded-lg border border-slate-200 dark:border-slate-700 text-sm">!</button>
                                <button onclick="CalcModule.insertFunction('œÄ')" class="calc-btn bg-slate-50 dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-800 dark:text-slate-200 py-2 rounded-lg border border-slate-200 dark:border-slate-700 text-sm">œÄ</button>
                            </div>
                            
                            <h4 class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2" data-i18n="advanced_functions">Advanced Functions</h4>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="CalcModule.insertFunction('derivative(')" class="calc-btn bg-slate-50 dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-800 dark:text-slate-200 py-2 rounded-lg border border-slate-200 dark:border-slate-700 text-xs">derivative(</button>
                                <button onclick="CalcModule.insertFunction('integral(')" class="calc-btn bg-slate-50 dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-800 dark:text-slate-200 py-2 rounded-lg border border-slate-200 dark:border-slate-700 text-xs">integral(</button>
                                <button onclick="CalcModule.insertFunction('det(')" class="calc-btn bg-slate-50 dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-800 dark:text-slate-200 py-2 rounded-lg border border-slate-200 dark:border-slate-700 text-xs">det(</button>
                                <button onclick="CalcModule.insertFunction('inv(')" class="calc-btn bg-slate-50 dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-800 dark:text-slate-200 py-2 rounded-lg border border-slate-200 dark:border-slate-700 text-xs">inv(</button>
                                <button onclick="CalcModule.insertFunction('e^')" class="calc-btn bg-slate-50 dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-800 dark:text-slate-200 py-2 rounded-lg border border-slate-200 dark:border-slate-700 text-xs">e^</button>
                                <button onclick="CalcModule.insertFunction('abs(')" class="calc-btn bg-slate-50 dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-800 dark:text-slate-200 py-2 rounded-lg border border-slate-200 dark:border-slate-700 text-xs">abs(</button>
                            </div>
                            
                            <div class="mt-4 pt-4 border-t border-slate-100 dark:border-slate-800">
                                <button onclick="CalcModule.clearExpression()" class="w-full bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/30 text-red-600 dark:text-red-400 font-medium py-2 rounded-lg transition-all flex justify-center items-center gap-2">
                                    <i class="fa-solid fa-eraser"></i> <span data-i18n="clear">Clear Expression</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Calculation Notes -->
                        <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm transition-colors duration-200">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                    <span class="bg-amber-600 text-white w-8 h-8 rounded-lg flex items-center justify-center text-sm"><i class="fa-solid fa-sticky-note"></i></span>
                                    <span data-i18n="calculation_notes">Calculation Notes</span>
                                </h3>
                                <div class="flex gap-2">
                                    <button onclick="NotesModule.saveNote()" class="text-xs font-medium text-amber-600 dark:text-amber-400 hover:text-amber-800 dark:hover:text-amber-300 px-2 py-1 bg-amber-50 dark:bg-amber-900/20 rounded-lg hover:bg-amber-100 dark:hover:bg-amber-900/30 transition">
                                        <i class="fa-solid fa-save mr-1"></i> <span data-i18n="save">Save</span>
                                    </button>
                                    <button onclick="NotesModule.clearNote()" class="text-xs font-medium text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-300 px-2 py-1 bg-slate-50 dark:bg-slate-800 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition">
                                        <i class="fa-solid fa-trash-can mr-1"></i> <span data-i18n="clear_btn">Clear</span>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1.5" data-i18n="note_title">Note Title</label>
                                    <input type="text" id="note-title" placeholder="Enter note title" 
                                        class="w-full pl-4 pr-4 py-3 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-100 font-medium placeholder-slate-400">
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1.5" data-i18n="note_content">Note Content</label>
                                    <textarea id="note-content" rows="4" placeholder="Add your notes, explanations or comments here..."
                                        class="w-full pl-4 pr-4 py-3 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-100 font-medium placeholder-slate-400"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1.5" data-i18n="saved_notes">Saved Notes</label>
                                    <div class="max-h-[200px] overflow-auto custom-scroll" id="saved-notes">
                                        <div class="text-center text-slate-400 dark:text-slate-500 py-4 text-sm" data-i18n="no_notes">No saved notes yet</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-6 text-slate-400 dark:text-slate-600 text-xs pb-4">
            &copy; 2025 calcure. All calculations are done locally. Your data remains private.
        </div>
    </div>

    <script>
        /* --- I18N (Multi-language) Module --- */
        const I18nModule = {
            currentLang: 'en',
            data: {
                'en': {
                    app_title: 'calcure',
                    app_subtitle: 'Advanced Mathematical Calculator',
                    dark_mode: 'Dark Mode',
                    light_mode: 'Light Mode',
                    calculation_area: 'Calculation Area',
                    expression: 'Mathematical Expression',
                    result: 'Result',
                    result_placeholder: 'Enter an expression and click = to calculate',
                    steps: 'Calculation Steps',
                    steps_placeholder: 'Steps will be shown here',
                    graph_plotter: 'Graph Plotter',
                    function: 'Function (y = ...)',
                    x_min: 'X Minimum',
                    x_max: 'X Maximum',
                    plot_graph: 'Plot Graph',
                    functions: 'Functions',
                    advanced_functions: 'Advanced Functions',
                    clear: 'Clear Expression',
                    clear_btn: 'Clear',
                    calculation_notes: 'Calculation Notes',
                    save: 'Save',
                    note_title: 'Note Title',
                    note_content: 'Note Content',
                    saved_notes: 'Saved Notes',
                    no_notes: 'No saved notes yet',
                    toast_success: 'Calculation successful',
                    toast_error: 'Invalid expression. Please check your input.',
                    toast_note_saved: 'Note saved successfully',
                    action_delete: 'Delete'
                },
                'zh-CN': {
                    app_title: 'ËÆ°ÁÆóÂô®',
                    app_subtitle: 'È´òÁ∫ßÊï∞Â≠¶ËÆ°ÁÆóÂô®',
                    dark_mode: 'Ê∑±Ëâ≤Ê®°Âºè',
                    light_mode: 'ÊµÖËâ≤Ê®°Âºè',
                    calculation_area: 'ËÆ°ÁÆóÂå∫Âüü',
                    expression: 'Êï∞Â≠¶Ë°®ËææÂºè',
                    result: 'ÁªìÊûú',
                    result_placeholder: 'ËæìÂÖ•Ë°®ËææÂºèÂπ∂ÁÇπÂáª=ËøõË°åËÆ°ÁÆó',
                    steps: 'ËÆ°ÁÆóÊ≠•È™§',
                    steps_placeholder: 'Ê≠•È™§Â∞ÜÊòæÁ§∫Âú®ËøôÈáå',
                    graph_plotter: 'ÂáΩÊï∞ÁªòÂõæ',
                    function: 'ÂáΩÊï∞ (y = ...)',
                    x_min: 'XÊúÄÂ∞èÂÄº',
                    x_max: 'XÊúÄÂ§ßÂÄº',
                    plot_graph: 'ÁªòÂà∂ÂõæÂΩ¢',
                    functions: 'ÂáΩÊï∞',
                    advanced_functions: 'È´òÁ∫ßÂáΩÊï∞',
                    clear: 'Ê∏ÖÈô§Ë°®ËææÂºè',
                    clear_btn: 'Ê∏ÖÈô§',
                    calculation_notes: 'ËÆ°ÁÆóÁ¨îËÆ∞',
                    save: '‰øùÂ≠ò',
                    note_title: 'Á¨îËÆ∞Ê†áÈ¢ò',
                    note_content: 'Á¨îËÆ∞ÂÜÖÂÆπ',
                    saved_notes: 'Â∑≤‰øùÂ≠òÁ¨îËÆ∞',
                    no_notes: 'ÊöÇÊó†‰øùÂ≠òÁöÑÁ¨îËÆ∞',
                    toast_success: 'ËÆ°ÁÆóÊàêÂäü',
                    toast_error: 'Ë°®ËææÂºèÊó†Êïà„ÄÇËØ∑Ê£ÄÊü•ÊÇ®ÁöÑËæìÂÖ•„ÄÇ',
                    toast_note_saved: 'Á¨îËÆ∞‰øùÂ≠òÊàêÂäü',
                    action_delete: 'Âà†Èô§'
                },
                'zh-TW': {
                    app_title: 'Ë®àÁÆóÂô®',
                    app_subtitle: 'È´òÁ¥öÊï∏Â≠∏Ë®àÁÆóÂô®',
                    dark_mode: 'Ê∑±Ëâ≤Ê®°Âºè',
                    light_mode: 'Ê∑∫Ëâ≤Ê®°Âºè',
                    calculation_area: 'Ë®àÁÆóÂçÄÂüü',
                    expression: 'Êï∏Â≠∏Ë°®ÈÅîÂºè',
                    result: 'ÁµêÊûú',
                    result_placeholder: 'Ëº∏ÂÖ•Ë°®ÈÅîÂºè‰∏¶ÈªûÊìä=ÈÄ≤Ë°åË®àÁÆó',
                    steps: 'Ë®àÁÆóÊ≠•È©ü',
                    steps_placeholder: 'Ê≠•È©üÂ∞áÈ°ØÁ§∫Âú®ÈÄôË£°',
                    graph_plotter: 'ÂáΩÊï∏Áπ™Âúñ',
                    function: 'ÂáΩÊï∏ (y = ...)',
                    x_min: 'XÊúÄÂ∞èÂÄº',
                    x_max: 'XÊúÄÂ§ßÂÄº',
                    plot_graph: 'Áπ™Ë£ΩÂúñÂΩ¢',
                    functions: 'ÂáΩÊï∏',
                    advanced_functions: 'È´òÁ¥öÂáΩÊï∏',
                    clear: 'Ê∏ÖÈô§Ë°®ÈÅîÂºè',
                    clear_btn: 'Ê∏ÖÈô§',
                    calculation_notes: 'Ë®àÁÆóÁ≠ÜË®ò',
                    save: '‰øùÂ≠ò',
                    note_title: 'Á≠ÜË®òÊ®ôÈ°å',
                    note_content: 'Á≠ÜË®òÂÖßÂÆπ',
                    saved_notes: 'Â∑≤‰øùÂ≠òÁ≠ÜË®ò',
                    no_notes: 'Êö´ÁÑ°‰øùÂ≠òÁöÑÁ≠ÜË®ò',
                    toast_success: 'Ë®àÁÆóÊàêÂäü',
                    toast_error: 'Ë°®ÈÅîÂºèÁÑ°Êïà„ÄÇË´ãÊ™¢Êü•ÊÇ®ÁöÑËº∏ÂÖ•„ÄÇ',
                    toast_note_saved: 'Á≠ÜË®ò‰øùÂ≠òÊàêÂäü',
                    action_delete: 'Âà™Èô§'
                },
                'ja': {
                    app_title: 'calcure',
                    app_subtitle: 'È´òÂ∫¶„Å™Êï∞Â≠¶Ë®àÁÆóÊ©ü',
                    dark_mode: '„ÉÄ„Éº„ÇØ„É¢„Éº„Éâ',
                    light_mode: '„É©„Ç§„Éà„É¢„Éº„Éâ',
                    calculation_area: 'Ë®àÁÆó„Ç®„É™„Ç¢',
                    expression: 'Êï∞Âºè',
                    result: 'ÁµêÊûú',
                    result_placeholder: 'Âºè„ÇíÂÖ•Âäõ„Åó„ÄÅ=„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Ë®àÁÆó',
                    steps: 'Ë®àÁÆóÊâãÈ†Ü',
                    steps_placeholder: 'ÊâãÈ†Ü„ÅØ„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô',
                    graph_plotter: '„Ç∞„É©„Éï„Éó„É≠„ÉÉ„Çø„Éº',
                    function: 'Èñ¢Êï∞ (y = ...)',
                    x_min: 'X„ÅÆÊúÄÂ∞èÂÄ§',
                    x_max: 'X„ÅÆÊúÄÂ§ßÂÄ§',
                    plot_graph: '„Ç∞„É©„Éï„ÇíÊèèÁîª',
                    functions: 'Èñ¢Êï∞',
                    advanced_functions: 'È´òÂ∫¶„Å™Èñ¢Êï∞',
                    clear: 'Âºè„Çí„ÇØ„É™„Ç¢',
                    clear_btn: '„ÇØ„É™„Ç¢',
                    calculation_notes: 'Ë®àÁÆó„É°„É¢',
                    save: '‰øùÂ≠ò',
                    note_title: '„É°„É¢„ÅÆ„Çø„Ç§„Éà„É´',
                    note_content: '„É°„É¢„ÅÆÂÜÖÂÆπ',
                    saved_notes: '‰øùÂ≠ò„Åï„Çå„Åü„É°„É¢',
                    no_notes: '„Åæ„Å†‰øùÂ≠ò„Åï„Çå„Åü„É°„É¢„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì',
                    toast_success: 'Ë®àÁÆó„ÅåÊàêÂäü„Åó„Åæ„Åó„Åü',
                    toast_error: 'Âºè„ÅåÁÑ°Âäπ„Åß„Åô„ÄÇÂÖ•Âäõ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                    toast_note_saved: '„É°„É¢„ÅåÊ≠£Â∏∏„Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åó„Åü',
                    action_delete: 'ÂâäÈô§'
                },
                'ru': {
                    app_title: 'calcure',
                    app_subtitle: '–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä',
                    dark_mode: '–¢–µ–º–Ω—ã–π —Ä–µ–∂–∏–º',
                    light_mode: '–°–≤–µ—Ç–ª—ã–π —Ä–µ–∂–∏–º',
                    calculation_area: '–û–±–ª–∞—Å—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–∏–π',
                    expression: '–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ',
                    result: '–†–µ–∑—É–ª—å—Ç–∞—Ç',
                    result_placeholder: '–í–≤–µ–¥–∏—Ç–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –∏ –Ω–∞–∂–º–∏—Ç–µ = –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è',
                    steps: '–®–∞–≥–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è',
                    steps_placeholder: '–®–∞–≥–∏ –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã –∑–¥–µ—Å—å',
                    graph_plotter: '–ì—Ä–∞—Ñ–∏–∫ —Ñ—É–Ω–∫—Ü–∏–∏',
                    function: '–§—É–Ω–∫—Ü–∏—è (y = ...)',
                    x_min: '–ú–∏–Ω–∏–º—É–º X',
                    x_max: '–ú–∞–∫—Å–∏–º—É–º X',
                    plot_graph: '–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫',
                    functions: '–§—É–Ω–∫—Ü–∏–∏',
                    advanced_functions: '–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏',
                    clear: '–û—á–∏—Å—Ç–∏—Ç—å –≤—ã—Ä–∞–∂–µ–Ω–∏–µ',
                    clear_btn: '–û—á–∏—Å—Ç–∏—Ç—å',
                    calculation_notes: '–ó–∞–º–µ—Ç–∫–∏ –æ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è—Ö',
                    save: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
                    note_title: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–º–µ—Ç–∫–∏',
                    note_content: '–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–º–µ—Ç–∫–∏',
                    saved_notes: '–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏',
                    no_notes: '–ï—â–µ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∑–∞–º–µ—Ç–æ–∫',
                    toast_success: '–í—ã—á–∏—Å–ª–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ',
                    toast_error: '–ù–µ–≤–µ—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–≤–æ–¥.',
                    toast_note_saved: '–ó–∞–º–µ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ',
                    action_delete: '–£–¥–∞–ª–∏—Ç—å'
                }
            },
            
            init: function() {
                const params = new URLSearchParams(window.location.search);
                const lang = params.get('lang');
                if (lang && this.i18n[lang]) {
                    document.getElementById('lang-selector').value = lang;
                    this.changeLang();
                    return;
                }
                // Initialize language
                const savedLang = localStorage.getItem('calcureLang');
                if (savedLang && this.data[savedLang]) {
                    this.currentLang = savedLang;
                    document.getElementById('lang-select').value = savedLang;
                }
                
                // Initialize theme
                const savedTheme = localStorage.getItem('calcureTheme');
                const isSystemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                
                if (savedTheme === 'dark' || (!savedTheme && isSystemDark)) {
                    document.documentElement.classList.add('dark');
                    this.updateThemeIcon(true);
                } else {
                    document.documentElement.classList.remove('dark');
                    this.updateThemeIcon(false);
                }
                
                this.updateTextContent();
            },
            
            changeLanguage: function(lang) {
                if (this.data[lang]) {
                    this.currentLang = lang;
                    localStorage.setItem('calcureLang', lang);
                    this.updateTextContent();
                }
            },
            
            updateThemeIcon: function(isDark) {
                const icon = document.querySelector('#theme-toggle i');
                const text = document.querySelector('#theme-toggle span');
                const currentLangData = this.data[this.currentLang];
                
                if (isDark) {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                    text.textContent = currentLangData.light_mode;
                } else {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                    text.textContent = currentLangData.dark_mode;
                }
            },
            
            updateTextContent: function() {
                const elements = document.querySelectorAll('[data-i18n]');
                elements.forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (this.data[this.currentLang][key]) {
                        el.textContent = this.data[this.currentLang][key];
                    }
                });
                
                // Also update the theme button text specifically
                const isDark = document.documentElement.classList.contains('dark');
                this.updateThemeIcon(isDark);
            }
        };

        /* --- Calculation Module --- */
        const CalcModule = {
            insertFunction: function(func) {
                const input = document.getElementById('math-expression');
                input.value += func;
                input.focus();
            },
            
            clearExpression: function() {
                document.getElementById('math-expression').value = '';
                
                const resultDiv = document.getElementById('calculation-result');
                resultDiv.innerHTML = `<span class="text-slate-400 dark:text-slate-500 font-normal text-base" data-i18n="result_placeholder">${I18nModule.data[I18nModule.currentLang].result_placeholder}</span>`;
                
                const stepsDiv = document.getElementById('calculation-steps');
                stepsDiv.innerHTML = `<span class="text-slate-400 dark:text-slate-500" data-i18n="steps_placeholder">${I18nModule.data[I18nModule.currentLang].steps_placeholder}</span>`;
                
                document.getElementById('math-expression').focus();
            },
            
            calculate: function() {
                const expression = document.getElementById('math-expression').value.trim();
                if (!expression) return;
                
                try {
                    // Evaluate the expression using math.js
                    const result = math.evaluate(expression);
                    const resultStr = math.format(result, { precision: 10 });
                    
                    // Display result
                    const resultDiv = document.getElementById('calculation-result');
                    resultDiv.innerHTML = resultStr; // Reset content to just result string
                    resultDiv.classList.remove('text-red-500', 'dark:text-red-400');
                    
                    // Generate calculation steps (simplified example)
                    this.generateSteps(expression, resultStr);
                    
                    App.showToast(I18nModule.data[I18nModule.currentLang].toast_success, 'success');
                } catch (error) {
                    const resultDiv = document.getElementById('calculation-result');
                    resultDiv.textContent = I18nModule.data[I18nModule.currentLang].toast_error;
                    resultDiv.classList.add('text-red-500', 'dark:text-red-400');
                    
                    setTimeout(() => {
                        if (resultDiv.textContent === I18nModule.data[I18nModule.currentLang].toast_error) {
                             resultDiv.classList.remove('text-red-500', 'dark:text-red-400');
                             // Optional: Revert to previous result or keep error
                        }
                    }, 2000);
                    
                    App.showToast(I18nModule.data[I18nModule.currentLang].toast_error, 'error');
                    console.error('Calculation error:', error);
                }
            },
            
            generateSteps: function(expression, result) {
                // Simplified step generation - in a real app this would be more detailed
                const stepsElement = document.getElementById('calculation-steps');
                stepsElement.innerHTML = `
                    <div class="mb-2"><strong>1.</strong> ${expression}</div>
                    <div><strong>2.</strong> ${I18nModule.data[I18nModule.currentLang].result}: ${result}</div>
                `;
            }
        };

        /* --- Graph Module --- */
        const GraphModule = {
            chart: null,
            
            plot: function() {
                const funcExpr = document.getElementById('function-expression').value.trim();
                const xMin = parseFloat(document.getElementById('x-min').value);
                const xMax = parseFloat(document.getElementById('x-max').value);
                
                if (!funcExpr || isNaN(xMin) || isNaN(xMax) || xMin >= xMax) {
                    App.showToast(I18nModule.data[I18nModule.currentLang].toast_error, 'error');
                    return;
                }
                
                try {
                    // Generate data points
                    const points = 100;
                    const step = (xMax - xMin) / points;
                    const xData = [];
                    const yData = [];
                    
                    for (let i = 0; i <= points; i++) {
                        const x = xMin + i * step;
                        xData.push(x);
                        
                        // Evaluate function at x
                        const scope = { x: x };
                        const y = math.evaluate(funcExpr, scope);
                        yData.push(y);
                    }
                    
                    // Get chart context
                    const ctx = document.getElementById('function-graph').getContext('2d');
                    
                    // Destroy previous chart if exists
                    if (this.chart) {
                        this.chart.destroy();
                    }
                    
                    // Check if dark mode is active to adjust chart colors
                    const isDark = document.documentElement.classList.contains('dark');
                    const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';
                    const textColor = isDark ? '#94a3b8' : '#64748b';
                    
                    // Create new chart
                    this.chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: xData,
                            datasets: [{
                                label: `y = ${funcExpr}`,
                                data: yData,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.1,
                                pointRadius: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'X',
                                        color: textColor
                                    },
                                    grid: {
                                        color: gridColor
                                    },
                                    ticks: {
                                        color: textColor
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Y',
                                        color: textColor
                                    },
                                    grid: {
                                        color: gridColor
                                    },
                                    ticks: {
                                        color: textColor
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        color: textColor
                                    }
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false
                                }
                            },
                            interaction: {
                                mode: 'nearest',
                                axis: 'x',
                                intersect: false
                            }
                        }
                    });
                } catch (error) {
                    App.showToast(I18nModule.data[I18nModule.currentLang].toast_error, 'error');
                    console.error('Graph error:', error);
                }
            }
        };

        /* --- Notes Module --- */
        const NotesModule = {
            notes: [],
            
            init: function() {
                const savedNotes = localStorage.getItem('calcureNotes');
                if (savedNotes) {
                    try {
                        this.notes = JSON.parse(savedNotes);
                        this.renderNotes();
                    } catch (e) {
                        console.error('Error loading notes:', e);
                        this.notes = [];
                    }
                }
            },
            
            saveNote: function() {
                const title = document.getElementById('note-title').value.trim();
                const content = document.getElementById('note-content').value.trim();
                
                if (!title) {
                    App.showToast(I18nModule.data[I18nModule.currentLang].toast_error, 'error');
                    return;
                }
                
                const note = {
                    id: Date.now(),
                    title: title,
                    content: content,
                    date: new Date().toISOString()
                };
                
                this.notes.unshift(note);
                this.saveNotes();
                this.renderNotes();
                
                App.showToast(I18nModule.data[I18nModule.currentLang].toast_note_saved, 'success');
                
                // Optional: Clear inputs after save
                // document.getElementById('note-title').value = '';
                // document.getElementById('note-content').value = '';
            },
            
            clearNote: function() {
                document.getElementById('note-title').value = '';
                document.getElementById('note-content').value = '';
            },
            
            deleteNote: function(id) {
                this.notes = this.notes.filter(note => note.id !== id);
                this.saveNotes();
                this.renderNotes();
            },
            
            saveNotes: function() {
                localStorage.setItem('calcureNotes', JSON.stringify(this.notes));
            },
            
            renderNotes: function() {
                const notesContainer = document.getElementById('saved-notes');
                
                if (this.notes.length === 0) {
                    notesContainer.innerHTML = `<div class="text-center text-slate-400 dark:text-slate-500 py-4 text-sm" data-i18n="no_notes">${I18nModule.data[I18nModule.currentLang].no_notes}</div>`;
                    return;
                }
                
                notesContainer.innerHTML = '';
                this.notes.forEach(note => {
                    const date = new Date(note.date);
                    const formattedDate = date.toLocaleDateString();
                    
                    const noteElement = document.createElement('div');
                    noteElement.className = 'bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg border border-slate-100 dark:border-slate-800 mb-2 hover:shadow-sm transition group';
                    noteElement.innerHTML = `
                        <div class="flex justify-between items-start mb-1">
                            <h4 class="font-medium text-slate-800 dark:text-slate-200">${note.title}</h4>
                            <button onclick="NotesModule.deleteNote(${note.id})" class="text-red-500/70 hover:text-red-600 dark:text-red-400/70 dark:hover:text-red-400 text-xs opacity-0 group-hover:opacity-100 transition-opacity p-1">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                        <p class="text-xs text-slate-500 dark:text-slate-400 mb-1 line-clamp-2">${note.content}</p>
                        <p class="text-xs text-slate-400 dark:text-slate-600">${formattedDate}</p>
                    `;
                    notesContainer.appendChild(noteElement);
                });
            }
        };

        /* --- Main App Module --- */
        const App = {
            init: function() {
                I18nModule.init();
                NotesModule.init();
                this.setupEventListeners();
            },
            
            setupEventListeners: function() {
                // Allow Enter key to calculate
                document.getElementById('math-expression').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        CalcModule.calculate();
                    }
                });
                
                // Theme toggle functionality
                document.getElementById('theme-toggle').addEventListener('click', () => {
                    document.documentElement.classList.toggle('dark');
                    
                    const isDark = document.documentElement.classList.contains('dark');
                    localStorage.setItem('calcureTheme', isDark ? 'dark' : 'light');
                    
                    I18nModule.updateThemeIcon(isDark);
                    
                    // Re-plot graph if it exists to update colors
                    if (GraphModule.chart) {
                        GraphModule.plot();
                    }
                });
            },
            
            showToast: function(message, type = 'success') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type} fade-in`;
                toast.innerHTML = type === 'success' 
                    ? `<i class="fa-solid fa-check-circle"></i> ${message}`
                    : `<i class="fa-solid fa-exclamation-circle"></i> ${message}`;
                
                container.appendChild(toast);
                
                // Remove toast after 3 seconds
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => {
                        if (container.contains(toast)) {
                            container.removeChild(toast);
                        }
                    }, 300);
                }, 3000);
            }
        };

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });
    </script>
</body>
</html>